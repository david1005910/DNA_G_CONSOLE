<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Governance Console</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #050505;
            --bg-secondary: #0a0a0a;
            --bg-accent: #111111;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border-color: #1a1a1a;
            --accent-color: #7c4dff;
            --btn-text: #ffffff;
            --neon-green: #00f5d4;
            --danger-color: #ff4444;
            --sidebar-width: 240px;
        }

        .mode-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-accent: #e5e5e5;
            --text-primary: #000000;
            --text-secondary: #222222;
            --border-color: #cccccc;
            --btn-text: #ffffff;
            --neon-green: #008888;
            --danger-color: #cc0000;
        }

        .theme-default { --accent-color: #7c4dff; }
        .theme-cyberpunk { --accent-color: #00fbff; --border-color: #004444; }
        .mode-light.theme-cyberpunk { --accent-color: #008888; --border-color: #bbdddd; --neon-green: #006666; }

        .theme-matrix { --accent-color: #00ff41; --border-color: #004400; }
        .mode-light.theme-matrix { --accent-color: #007700; --border-color: #bbccbb; --neon-green: #005500; }

        .theme-crimson { --accent-color: #ff1e1e; --border-color: #550000; }
        .mode-light.theme-crimson { --accent-color: #cc0000; --border-color: #ddbbbb; --neon-green: #880000; }

        .theme-industrial { --accent-color: #ff9f1c; --border-color: #442200; }
        .mode-light.theme-industrial { --accent-color: #cc6600; --border-color: #ddccbb; --neon-green: #774400; }

        .theme-cobalt { --accent-color: #4cc9f0; --border-color: #002244; }
        .mode-light.theme-cobalt { --accent-color: #0055aa; --border-color: #bbccdd; --neon-green: #003366; }

        .theme-mono { --accent-color: #ffffff; --border-color: #333333; --btn-text: #000000; }
        .mode-light.theme-mono { 
            --accent-color: #000000; 
            --border-color: #aaaaaa; 
            --text-primary: #000000 !important; 
            --text-secondary: #000000 !important;
            --btn-text: #ffffff;
            --neon-green: #000000 !important;
        }

        * { border-radius: 0 !important; box-shadow: none !important; transition: background 0.1s, border-color 0.1s, color 0.1s; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); }
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        #root { display: flex; width: 100vw; height: 100vh; }

        .sidebar { width: 64px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: width 0.3s; z-index: 1000; flex-shrink: 0; position: relative; }
        .sidebar.expanded { width: var(--sidebar-width); }
        .sidebar-header { height: 64px; padding: 0 20px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .sidebar.expanded .sidebar-header { justify-content: space-between; }
        .sidebar-brand { font-size: 0.8rem; font-weight: 800; color: var(--accent-color); letter-spacing: 1px; white-space: nowrap; opacity: 0; width: 0; overflow: hidden; transition: opacity 0.3s, width 0.3s; }
        .sidebar.expanded .sidebar-brand { opacity: 1; width: auto; }
        .toggle-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        
        .tab-list { list-style: none; padding: 10px 0; margin: 0; flex: 1; }
        .tab-item { height: 52px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; border-left: 3px solid transparent; overflow: hidden; }
        .tab-item .icon-box { min-width: 64px; display: flex; justify-content: center; align-items: center; }
        .tab-item span { font-size: 0.8rem; font-weight: 700; opacity: 0; white-space: normal; line-height: 1.1; padding-right: 10px; }
        .sidebar.expanded .tab-item span { opacity: 1; }
        .tab-item:hover { background-color: var(--bg-accent); }
        .tab-item.active { background-color: var(--bg-accent); color: var(--accent-color); border-left-color: var(--accent-color); }

        .main-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); }
        .content-header { height: 64px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); position: relative; }
        .content-header h2 { margin: 0; font-weight: 800; font-size: 1rem; text-transform: uppercase; }

        .system-status-indicator { display: flex; align-items: center; gap: 15px; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 5px 12px; background: var(--bg-accent); border: 1px solid var(--border-color); font-size: 0.65rem; font-weight: 800; }
        .status-dot { width: 6px; height: 6px; border-radius: 50% !important; background: var(--text-secondary); }
        .status-active .status-dot { background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .status-progress-container { width: 120px; height: 4px; background: var(--bg-accent); border: 1px solid var(--border-color); position: relative; overflow: hidden; }
        .status-progress-bar { height: 100%; background: var(--accent-color); transition: width 0.3s linear; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; overflow-x: hidden; }

        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); margin-bottom: 24px; }
        .card-header { padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.05); }
        .card-title { font-size: 0.70rem; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; }
        .card-body { padding: 24px; }

        .btn { border: 1px solid var(--border-color); padding: 10px 20px; font-weight: 800; cursor: pointer; font-size: 0.7rem; text-transform: uppercase; background: var(--bg-accent); color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .btn-accent { background: var(--accent-color); color: var(--btn-text); border-color: var(--accent-color); }
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); }

        .type-toggle-container { display: flex; border: 1px solid var(--border-color); background: var(--bg-accent); }
        .type-toggle-btn { padding: 8px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 900; font-size: 0.75rem; transition: 0.2s; }
        .type-toggle-btn.active { background: var(--accent-color); color: var(--btn-text); }

        .log-box { background: rgba(0,0,0,0.9); padding: 16px; color: var(--neon-green); font-family: 'Fira Code', monospace; font-size: 0.8rem; border: 1px solid var(--border-color); }
        .mode-light .log-box { background: #fdfdfd; color: var(--neon-green); font-weight: 800; }
        .log-line { border-bottom: 1px solid var(--border-color); padding: 8px 0; }

        .db-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .db-table th { background: var(--bg-accent); padding: 12px 18px; color: var(--accent-color); text-align: left; border-bottom: 2px solid var(--accent-color); font-weight: 800; text-transform: uppercase; }
        .db-table td { padding: 12px 18px; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-weight: 600; }
        .col-dna { font-family: 'Fira Code', monospace; color: var(--neon-green) !important; font-weight: 800 !important; }
        
        .inspect-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); margin-bottom: 24px; }
        .inspect-stat { background: var(--bg-secondary); padding: 25px; overflow: hidden; }
        .inspect-stat h4 { margin: 0 0 12px 0; font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 800; }
        .inspect-stat .val { font-size: 1.5rem; font-weight: 800; color: var(--accent-color); word-break: break-word; line-height: 1.2; }
        
        /* RESTORED TAG STYLES */
        .val-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .val-tag { font-size: 0.6rem; font-weight: 800; padding: 4px 10px; background: var(--bg-accent); border: 1px solid var(--border-color); color: var(--text-secondary); letter-spacing: 0.5px; }
        .val-tag.active { border-color: var(--accent-color); color: var(--accent-color); }
        .val-tag.success { border-color: var(--neon-green); color: var(--neon-green); }

        .bar-container { display: flex; align-items: center; margin-bottom: 18px; }
        .bar-label { font-family: 'Fira Code', monospace; font-size: 0.75rem; color: var(--text-secondary); width: 130px; font-weight: 700; }
        .bar-wrapper { flex: 1; background: var(--bg-accent); height: 14px; margin: 0 15px; border: 1px solid var(--border-color); }
        .bar-fill { height: 100%; background: var(--accent-color); }

        .mode-switcher { display: flex; border: 1px solid var(--border-color); background: var(--bg-accent); }
        .mode-btn { padding: 10px 25px; cursor: pointer; border: none; background: transparent; color: var(--text-secondary); font-size: 0.75rem; font-weight: 800; }
        .mode-btn.active { background: var(--accent-color); color: var(--btn-text); }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .theme-item { border: 1px solid var(--border-color); padding: 15px; cursor: pointer; text-align: center; background: var(--bg-secondary); }
        .theme-item.active { border: 2px solid var(--accent-color); }
        .theme-preview { width: 100%; height: 24px; margin-bottom: 8px; }

        .pulse { animation: simple-pulse 2s infinite; }
        @keyframes simple-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .pagination-controls { display: flex; align-items: center; gap: 5px; }
        .page-btn { padding: 4px 8px; font-size: 0.6rem; font-weight: 800; border: 1px solid var(--border-color); background: var(--bg-accent); color: var(--text-secondary); cursor: pointer; }
        .page-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .page-btn.active { background: var(--accent-color); color: var(--btn-text); border-color: var(--accent-color); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* HOVER PANEL */
        .status-hover-panel {
            position: absolute;
            top: 50px;
            right: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-color);
            padding: 20px;
            min-width: 280px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .system-status-indicator:hover .status-hover-panel {
            opacity: 1;
            visibility: visible;
            top: 60px;
        }
        .panel-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-secondary); font-weight: 700; }
        .panel-row:last-child { border-bottom: none; }
        .panel-val { color: var(--text-primary); }

        /* Markdown Styling */
        .markdown-body {
            color: var(--text-primary);
            line-height: 1.8;
            font-family: 'Inter', sans-serif;
            max-width: 900px;
            margin: 0 auto;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            margin-top: 40px;
            margin-bottom: 20px;
            font-weight: 900;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .markdown-body h1 { font-size: 2rem; border-bottom: 2px solid var(--accent-color); }
        .markdown-body h2 { font-size: 1.4rem; }
        .markdown-body h3 { font-size: 1.1rem; border: none; padding: 0; }
        .markdown-body p { margin-bottom: 20px; font-size: 0.95rem; color: var(--text-secondary); }
        .markdown-body strong { color: var(--text-primary); font-weight: 700; }
        .markdown-body ul, .markdown-body ol { margin-bottom: 25px; padding-left: 25px; font-size: 0.95rem; color: var(--text-secondary); }
        .markdown-body li { margin-bottom: 8px; }
        .markdown-body code {
            font-family: 'Fira Code', monospace;
            background: var(--bg-accent);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--neon-green);
            border: 1px solid var(--border-color);
        }
        .markdown-body pre {
            background: #000000;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .markdown-body pre code {
            background: transparent;
            padding: 0;
            color: #ccc;
            border: none;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 30px;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .markdown-body th, .markdown-body td {
            border: 0.5px solid var(--border-color);
            padding: 14px 20px;
            text-align: left;
        }
        .markdown-body th {
            background: var(--bg-accent);
            color: var(--accent-color);
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }
        .markdown-body td {
            background: rgba(255,255,255,0.02);
        }
        .markdown-body blockquote {
            padding: 20px 30px;
            color: var(--text-secondary);
            border-left: 4px solid var(--accent-color);
            margin: 30px 0;
            background: rgba(124, 77, 255, 0.08);
            font-style: italic;
            border-radius: 0 8px 8px 0;
        }
        .markdown-body hr {
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
            margin: 40px 0;
        }

        /* Document Editor Styles */
        .doc-panel { display: flex; height: 100%; border: 1px solid var(--border-color); background: var(--bg-secondary); }
        .doc-sidebar { width: 220px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: var(--bg-primary); }
        .doc-list { flex: 1; overflow-y: auto; }
        .doc-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); transition: all 0.2s; border-left: 2px solid transparent; font-size: 0.8rem; }
        .doc-item:hover { background: var(--bg-accent); }
        .doc-item.active { background: var(--bg-accent); color: var(--accent-color); border-left-color: var(--accent-color); font-weight: 600; }
        .doc-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); }
        .doc-toolbar { padding: 10px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); }
        .doc-title-input { background: transparent; border: none; color: var(--text-primary); font-size: 1.1rem; font-weight: 700; min-width: 350px; outline: none; }
        .doc-body { flex: 1; display: flex; overflow: hidden; }
        .doc-editor { width: 100%; height: 100%; background: var(--bg-primary); color: var(--text-primary); border: none; padding: 20px; font-family: 'Fira Code', monospace; line-height: 1.6; resize: none; outline: none; font-size: 0.9rem; }
        .doc-preview { width: 100%; height: 100%; padding: 20px; overflow-y: auto; color: var(--text-primary); line-height: 1.6; }
        .doc-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); gap: 10px; }
        .doc-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 4px 8px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 4px; border-radius: 4px; }
        .doc-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .doc-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }
    </style>
</head>
<body class="mode-dark theme-default">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        const LucideIcon = ({ name, size = 16, className, style }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && name) {
                    ref.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: {
                            width: size,
                            height: size,
                            class: className || ''
                        }
                    });
                }
            }, [name, size, className]);
            return <i ref={ref} style={{ display: 'inline-flex', ...style }}></i>;
        };

        const AppContext = createContext();

        const THEMES = [
            { id: 'default', name: 'PURE_VIOLET', color: '#7c4dff' },
            { id: 'cyberpunk', name: 'NEON_GLITCH', color: '#00fbff' },
            { id: 'matrix', name: 'OVERRIDE', color: '#00ff41' },
            { id: 'crimson', name: 'RED_LINE', color: '#ff1e1e' },
            { id: 'industrial', name: 'ORANGE_V8', color: '#ff9f1c' },
            { id: 'cobalt', name: 'DEEP_SEA', color: '#4cc9f0' },
            { id: 'mono', name: 'MONOTONE', color: '#888888' }
        ];

        const DICTIONARY = {
            en: {
                // Tabs
                title: "DNA_G_OS", tab_control: "CONTROL", tab_db: "REGISTRY", tab_master: "MASTER DB", tab_report: "REPORT", tab_neural: "ANALYSIS", tab_docs: "DOCUMENTS", tab_settings: "SETTINGS",
                
                // Settings
                lbl_mode: "SYSTEM MODE", lbl_theme: "CONSOLE THEME", lbl_lang: "SYSTEM LANGUAGE",
                mode_light: "LIGHT_MODE", mode_dark: "DARK_MODE",
                
                // Control Panel
                btn_manual: "MANU_CAP", btn_auto_start: "ENGAGE", btn_auto_stop: "HALT", btn_reset: "WIPE", btn_retrain: "EMBEDDING_RETRAIN",
                btn_seq_analysis: "SEQ_TRAIN", btn_meta_analysis: "META_TRAIN", lbl_virus_analysis: "VIRUS IDENTITY ANALYSIS",
                tab_virus: "VIRUS ANALYSIS", tab_insights: "INSIGHTS",
                btn_download_sandbox: "DOWNLOAD SANDBOX", btn_download_db: "EXPORT DB (CSV)",
                lbl_operations: "Operations Control", lbl_dna_archived: "DNA_ARCHIVED", lbl_rna_archived: "RNA_ARCHIVED",
                lbl_total_target: "TOTAL_TARGET", lbl_collection_rate: "COLLECTION_RATE",
                log_waiting: "WAITING_FOR_SIGNAL...", log_training: "TRAINING...",
                
                // Reset Modal
                reset_title: "⚠️ Factory Reset Confirmation", reset_warning: "The following data will be permanently deleted:",
                reset_genetic: "genetic_records - All genetic record data",
                reset_raw: "raw_genetic_captures - Raw capture data",
                reset_meta: "system_metadata - System metadata",
                reset_model: "ML Model - Trained AI model (reset & retrain)",
                reset_irreversible: "⚠️ This action cannot be undone!",
                reset_cancel: "Cancel", reset_confirm: "Confirm, Execute Reset", reset_processing: "Resetting...",
                
                // Database Panel
                db_title: "Archive Registry", db_limit: "LIMIT", db_loading: "LOADING_ARCHIVE...",
                db_hash_id: "HASH_ID", db_type: "TYPE", db_sequence: "SEQUENCE_STREAM",
                db_showing: "Showing", db_of: "of", db_records: "records",
                db_prev: "PREV", db_next: "NEXT",
                
                // Neural Panel
                neural_algo: "ALGO_ENGINE", neural_vector: "VECTOR_DIM", neural_accuracy: "ACCURACY",
                neural_f1: "F1_SCORE", neural_train: "TRAIN", neural_test: "TEST",
                neural_precision: "P", neural_recall: "R", neural_sync: "SYNC_OK", neural_classifying: "CLASSIFYING",
                neural_confusion: "Confusion Matrix", neural_confidence: "Confidence Distribution",
                neural_high: "HIGH (≥80%)", neural_medium: "MEDIUM (50-80%)", neural_low: "LOW (<50%)",
                neural_features: "Feature Sensitivity Analytics (Top 10)", neural_extended: "EXTENDED VECTOR SPACE",
                neural_dimensions: "dimensions", neural_more: "more",
                neural_pred_a: "PRED: A", neural_pred_b: "PRED: B", neural_true_a: "TRUE: A", neural_true_b: "TRUE: B",
                neural_syncing: "SYNCING_NEURAL_ENGINE...",
                btn_download_pdf: "DOWNLOAD PDF REPORT",
                
                // Documents
                doc_new: "NEW", doc_edit: "EDIT", doc_preview: "VIEW", doc_enhance: "ENHANCE", doc_save: "SAVE",
                doc_empty: "Select or Create Document", doc_untitled: "Untitled", doc_placeholder: "Write in Markdown...",
                doc_model_title: "SELECT AI MODEL", doc_model_cancel: "CANCEL", doc_model_confirm: "CONFIRM", doc_enhancing: "ENHANCING...",
                
                // Settings
                settings_title: "System Calibration",
                
                // Status Hover
                st_active: "COLLECTION ACTIVE", st_system: "SYSTEM STATUS",
                st_bot_mode: "BOT MODE", st_running: "RUNNING", st_idle: "IDLE",
                st_status: "STATUS", st_auto: "AUTO_COLLECTING", st_standby: "STANDBY",
                st_total: "TOTAL TARGET", st_down: "DOWNLOADED", st_remain: "REMAINING",
                st_batch: "BATCH PROGRESS (200/batch)", st_overall: "OVERALL PROGRESS",
                st_elapsed: "ELAPSED", st_est: "EST. REMAINING", st_speed: "SPEED",
                st_guide: "Click 'ENGAGE' in Control Panel\nto start auto-collection."
            },
            ko: {
                // Tabs
                title: "DNA_G_CONSOLE", tab_control: "제어 센터", tab_db: "레지스트리", tab_master: "마스터 DB", tab_report: "프로젝트", tab_neural: "엔진 분석", tab_docs: "문서 관리", tab_settings: "환경 설정",
                
                // Settings
                lbl_mode: "시스템 배경 모드", lbl_theme: "콘솔 테마 색상", lbl_lang: "시스템 언어",
                mode_light: "라이트 모드", mode_dark: "다크 모드",
                
                // Control Panel
                btn_manual: "수동 수집", btn_auto_start: "자동 가동", btn_auto_stop: "가동 중지", btn_reset: "공장 초기화", btn_retrain: "임베딩 재학습",
                btn_seq_analysis: "시퀀스 학습", btn_meta_analysis: "메타 분석", lbl_virus_analysis: "바이러스 동일성 분석",
                tab_virus: "바이러스 분석", tab_insights: "인사이트",
                btn_download_sandbox: "샌드박스 다운로드", btn_download_db: "DB 내보내기 (CSV)",
                lbl_operations: "작업 제어", lbl_dna_archived: "DNA 보관됨", lbl_rna_archived: "RNA 보관됨",
                lbl_total_target: "전체 대상", lbl_collection_rate: "수집률",
                log_waiting: "신호 대기 중...", log_training: "학습 중...",
                
                // Reset Modal
                reset_title: "⚠️ 공장 초기화 확인", reset_warning: "다음 데이터가 완전히 삭제됩니다:",
                reset_genetic: "genetic_records - 모든 유전 기록 데이터",
                reset_raw: "raw_genetic_captures - 원시 캡처 데이터",
                reset_meta: "system_metadata - 시스템 메타데이터",
                reset_model: "ML Model - 학습된 AI 모델 (초기화 재학습)",
                reset_irreversible: "⚠️ 이 작업은 되돌릴 수 없습니다!",
                reset_cancel: "취소", reset_confirm: "확인, 초기화 실행", reset_processing: "초기화 중...",
                
                // Database Panel
                db_title: "아카이브 레지스트리", db_limit: "제한", db_loading: "아카이브 로딩 중...",
                db_hash_id: "해시_ID", db_type: "타입", db_sequence: "시퀀스_스트림",
                db_showing: "표시 중", db_of: "/", db_records: "레코드",
                db_prev: "이전", db_next: "다음",
                
                // Neural Panel
                neural_algo: "알고리즘 엔진", neural_vector: "벡터 차원", neural_accuracy: "정확도",
                neural_f1: "F1 점수", neural_train: "훈련", neural_test: "테스트",
                neural_precision: "정밀도", neural_recall: "재현율", neural_sync: "동기화 완료", neural_classifying: "분류 중",
                neural_confusion: "혼동 행렬", neural_confidence: "신뢰도 분포",
                neural_high: "높음 (≥80%)", neural_medium: "중간 (50-80%)", neural_low: "낮음 (<50%)",
                neural_features: "특징 민감도 분석 (상위 10개)", neural_extended: "확장 벡터 공간",
                neural_dimensions: "차원", neural_more: "개 더보기",
                neural_pred_a: "예측: A", neural_pred_b: "예측: B", neural_true_a: "실제: A", neural_true_b: "실제: B",
                neural_syncing: "신경망 엔진 동기화 중...",
                btn_download_pdf: "PDF 리포트 다운로드",
                
                // Documents
                doc_new: "새 문서", doc_edit: "편집", doc_preview: "보기", doc_enhance: "가독성 향상", doc_save: "저장",
                doc_empty: "문서를 선택하거나 새로 만드세요", doc_untitled: "제목 없음", doc_placeholder: "Markdown으로 작성하세요...",
                doc_model_title: "AI 모델 선택", doc_model_cancel: "취소", doc_model_confirm: "확인", doc_enhancing: "향상 중...",
                
                // Settings
                settings_title: "시스템 보정",
                
                // Status Hover
                st_active: "수집 활성화됨", st_system: "시스템 상태",
                st_bot_mode: "봇 모드", st_running: "가동 중", st_idle: "대기",
                st_status: "상태", st_auto: "자동 수집 중", st_standby: "대기 중",
                st_total: "전체 대상", st_down: "다운로드됨", st_remain: "남음",
                st_batch: "배치 진행률 (200/배치)", st_overall: "전체 진행률",
                st_elapsed: "경과 시간", st_est: "예상 남은 시간", st_speed: "속도",
                st_guide: "제어 센터에서 '자동 가동'을 클릭하여\n자동 수집을 시작하세요."
            }
        };

        const AppProvider = ({ children }) => {
            const [isAuto, setIsAuto] = useState(false);
            const [logs, setLogs] = useState([]);

            const [lang, setLang] = useState(localStorage.getItem('lang') || 'ko');
            
            useEffect(() => {
                console.log("[DEBUG] AppProvider Mounted. isAuto:", isAuto);
            }, []);
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'default');
            const [sysMode, setSysMode] = useState(localStorage.getItem('sysMode') || 'dark');
            const [activeType, setActiveType] = useState('DNA');
            const [sidebarExpanded, setSidebarExpanded] = useState(true);
            const [sortBy, setSortBy] = useState('relevance'); // 'relevance' or 'date'
            const [progress, setProgress] = useState(0);

            // Phase 1 & 5: State Management & Real Data Sync
            const [totalDataCount, setTotalDataCount] = useState(0); // Real total from NCBI
            const [downloadedCount, setDownloadedCount] = useState(0); // Real DB count
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);

            const autoInterval = useRef(null);
            const progressInterval = useRef(null);
            const isAutoRef = useRef(false); // isAuto 상태를 ref로 추적하여 클로저 문제 해결
            const activeTypeRef = useRef(activeType); // activeType도 ref로 추적

            // isAuto 상태 변경 시 ref 동기화
            useEffect(() => {
                isAutoRef.current = isAuto;
            }, [isAuto]);
            
            // activeType 변경 시 ref 동기화 및 자동수집 중지
            useEffect(() => {
                activeTypeRef.current = activeType;
                // 타입 변경 시 자동수집 중지
                if (isAutoRef.current) {
                    stopAutoCollection();
                }
            }, [activeType]);

            // 컴포넌트 언마운트 시 interval 정리
            useEffect(() => {
                return () => {
                    if (autoInterval.current) clearInterval(autoInterval.current);
                    if (progressInterval.current) clearInterval(progressInterval.current);
                };
            }, []);

            const t = (key) => DICTIONARY[lang][key] || key;
            const addLog = (msg) => setLogs(p => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...p]);

            // Initial Stats Sync
            useEffect(() => {
                // 1. Get Local DB Stats
                fetch('/api/records/stats')
                    .then(r => r.json())
                    .then(stats => {
                        const currentCount = activeType === 'DNA' ? stats.dna_count : stats.rna_count;
                        setDownloadedCount(currentCount);
                    })
                    .catch(err => console.error("Stats Fetch Error:", err));

                // 2. Get Real NCBI Total Count
                fetch(`/api/records/ncbi_meta?type=${activeType}`)
                    .then(r => r.json())
                    .then(meta => {
                        if(meta.total_count) setTotalDataCount(meta.total_count);
                    })
                    .catch(err => console.error("NCBI Meta Fetch Error:", err));
            }, [activeType]);

            const fetchSamples = async (overrideCount = 10, origin = "manual") => {
                console.log(`[DEBUG] fetchSamples called! count=${overrideCount}, origin=${origin}, isAuto=${isAutoRef.current}, sort=${sortBy}`);
                addLog(`DEBUG: FETCH_SAMPLES_TRIGGERED (ORIGIN: ${origin}, SORT: ${sortBy})`);
                setProgress(0);
                try {
                    const r = await fetch('/api/records/fetch_samples', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            count: overrideCount, 
                            record_type: activeTypeRef.current,
                            sort: sortBy
                        }) 
                    });
                    const d = await r.json();
                    if(d.status === 'success') {
                        addLog(`SUCCESS: +${d.added} ${activeTypeRef.current} DATA_BLOCKS_STORED`);
                        
                        // Phase 5: Live updates from backend response
                        if (d.total_available) setTotalDataCount(d.total_available);
                        
                        setDownloadedCount(prev => prev + d.added);
                    } else {
                        addLog(`WARNING: ${d.message || 'Unknown response'}`);
                    }
                } catch (e) {
                    addLog(`ERROR: ${e.message}`);
                    console.error("Fetch Error Detail:", e);
                }
            };

            const stopAutoCollection = () => {
                if (autoInterval.current) clearInterval(autoInterval.current);
                if (progressInterval.current) clearInterval(progressInterval.current);
                autoInterval.current = null;
                progressInterval.current = null;
                setIsAuto(false);
                setProgress(0);
                addLog("SYSTEM: AUTOMATIC_COLLECTION_STOPPED");
            };

            const toggleAuto = (isManual = false) => {
                if (!isManual && !isAutoRef.current) {
                    console.warn("[DEBUG] toggleAuto called but NOT manually! Ignoring.");
                    return;
                }
                if (isAutoRef.current) { 
                    stopAutoCollection();
                }
                else { 
                    setIsAuto(true);
                    isAutoRef.current = true; // 즉시 ref도 업데이트
                    
                    // Init Session
                    if (!startTime) setStartTime(Date.now());

                    addLog(`SYSTEM: AUTOMATIC_COLLECTION_ENGAGED (${activeType}) - BATCH_SIZE: 200`); 
                    fetchSamples(200, "auto_engage"); // Trigger first fetch immediately
                    
                    autoInterval.current = setInterval(() => {
                        fetchSamples(200, "auto_interval");
                    }, 10000); // 10초 간격
                    
                    let p = 0;
                    progressInterval.current = setInterval(() => {
                        p += 1.0; // 10초에 맞춰 조정 (100ms * 100 = 10초)
                        if (p > 100) p = 0;
                        setProgress(p);
                    }, 100);
                }
            };

            useEffect(() => { 
                document.body.className = `mode-${sysMode} theme-${theme}`; 
                localStorage.setItem('theme', theme); 
                localStorage.setItem('sysMode', sysMode);
                localStorage.setItem('lang', lang);
            }, [theme, sysMode, lang]);

            return <AppContext.Provider value={{ 
                isAuto, toggleAuto, logs, lang, setLang, t, activeType, setActiveType, 
                sidebarExpanded, setSidebarExpanded, theme, setTheme, sysMode, setSysMode, progress,
                totalDataCount, downloadedCount, startTime, elapsedTime, setElapsedTime,
                fetchSamples, sortBy, setSortBy // Expose fetchSamples, sortBy
            }}>{children}</AppContext.Provider>;
        };

        const ControlPanel = () => {
            const { isAuto, toggleAuto, logs, t, activeType, setActiveType, fetchSamples, totalDataCount, downloadedCount, sortBy, setSortBy } = useContext(AppContext);
            const [retrainLoading, setRetrainLoading] = useState(false);
            const [seqTrainLoading, setSeqTrainLoading] = useState(false);
            const [metaTrainLoading, setMetaTrainLoading] = useState(false);
            const [stats, setStats] = useState(null);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
            const [downloading, setDownloading] = useState(null); // 'sandbox', 'db', null

            const handleDownload = (url, type) => {
                setDownloading(type);
                // 가짜 로딩 효과
                setTimeout(() => {
                     window.location.href = url;
                     // 다운로드가 시작되면 잠시 후 상태 초기화 (실제 다운로드 완료 감지는 어려움)
                     setTimeout(() => setDownloading(null), 3000);
                }, 500);
            };

            useEffect(() => {
                fetch('/api/records/stats').then(r=>r.json()).then(setStats);
            }, [downloadedCount]);

            useEffect(() => {
                lucide.createIcons();
            }, [downloading, retrainLoading, isAuto]); // UI 상태 변경 시 아이콘 갱신

            const handleRetrain = async () => {
                setRetrainLoading(true);
                try {
                    const r = await fetch('/api/ml/retrain', {method: 'POST'});
                    const d = await r.json();
                    if (d.status === 'success') {
                        alert('EMBEDDING_RETRAIN: SUCCESS - ' + d.message);
                    } else {
                        alert('EMBEDDING_RETRAIN: FAILED - ' + (d.message || 'Unknown error'));
                    }
                } catch(e) {
                    alert('EMBEDDING_RETRAIN: ERROR - ' + e.message);
                } finally {
                    setRetrainLoading(false);
                }
            };

            const handleSeqTrain = async () => {
                setSeqTrainLoading(true);
                try {
                    const r = await fetch('/api/ml/sequence-train', {method: 'POST'});
                    const d = await r.json();
                    if (d.status === 'success') {
                        alert('SEQUENCE_TRAIN: SUCCESS\n' + d.message);
                    } else {
                        alert('SEQUENCE_TRAIN: FAILED - ' + d.message);
                    }
                } catch(e) {
                    alert('SEQUENCE_TRAIN: ERROR - ' + e.message);
                } finally {
                    setSeqTrainLoading(false);
                }
            };

            const handleMetaTrain = async () => {
                setMetaTrainLoading(true);
                try {
                    const r = await fetch('/api/analysis/virus-identity', {method: 'POST'});
                    const d = await r.json();
                    if (d.status === 'success') {
                        alert(`META_ANALYSIS: SUCCESS\n동일 시퀀스 그룹: ${d.identical_groups}개\n총 분석 레코드: ${d.total_records}개`);
                    } else {
                        alert('META_ANALYSIS: FAILED - ' + d.message);
                    }
                } catch(e) {
                    alert('META_ANALYSIS: ERROR - ' + e.message);
                } finally {
                    setMetaTrainLoading(false);
                }
            };

            return (
                <div>
                    {/* Stats Card */}
                    <div className="inspect-grid" style={{marginBottom:24}}>
                        <div className="inspect-stat">
                            <h4>{t('lbl_dna_archived')}</h4>
                            <span className="val">{(stats?.dna_count || 0).toLocaleString()}</span>
                        </div>
                        <div className="inspect-stat">
                            <h4>{t('lbl_rna_archived')}</h4>
                            <span className="val">{(stats?.rna_count || 0).toLocaleString()}</span>
                        </div>
                        <div className="inspect-stat">
                            <h4>{t('lbl_total_target')}</h4>
                            <span className="val">{totalDataCount.toLocaleString()}</span>
                        </div>
                        <div className="inspect-stat">
                            <h4>{t('lbl_collection_rate')}</h4>
                            <span className="val">{totalDataCount > 0 ? ((downloadedCount / totalDataCount) * 100).toFixed(2) : 0}%</span>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <span className="card-title">{t('lbl_operations')}</span>
                            <div className="type-toggle-container">
                                <button className={`type-toggle-btn ${activeType==='DNA'?'active':''}`} onClick={()=>setActiveType('DNA')}>DNA</button>
                                <button className={`type-toggle-btn ${activeType==='RNA'?'active':''}`} onClick={()=>setActiveType('RNA')}>RNA</button>
                            </div>
                        </div>
                        <div className="card-body">
                            <div style={{display:'grid', gridTemplateColumns:'1fr 2.5fr', gap:30}}>
                                <div style={{display:'flex', flexDirection:'column', gap:12}}>
                                    {/* Sort Control */}
                                    <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', background:'var(--bg-primary)', padding:8, border:'1px solid var(--border-color)'}}>
                                        <span style={{fontSize:'0.65rem', fontWeight:800, color:'var(--text-secondary)'}}>SORT BY:</span>
                                        <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} style={{background:'transparent', border:'none', color:'var(--accent-color)', fontSize:'0.7rem', fontWeight:800, cursor:'pointer', textAlign:'right'}}>
                                            <option value="relevance">RELEVANCE</option>
                                            <option value="date">DATE (NEWEST)</option>
                                        </select>
                                    </div>
                                    
                                    <button className="btn" onClick={() => fetchSamples(50, "manual_click")}>
                                        <i data-lucide="zap" style={{width:16, height:16}}></i> {t('btn_manual')}
                                    </button>
                                    <button className={`btn btn-accent ${isAuto?'pulse':''}`} onClick={() => toggleAuto(true)}>
                                        <i data-lucide={isAuto ? "square" : "play"} style={{width:16, height:16}}></i> {isAuto ? t('btn_auto_stop') : t('btn_auto_start')}
                                    </button>
                                    <button className="btn" onClick={handleRetrain} disabled={retrainLoading} style={{opacity: retrainLoading ? 0.5 : 1}}>
                                        <i data-lucide="cpu" style={{width:16, height:16}}></i> {retrainLoading ? t('log_training') : t('btn_retrain')}
                                    </button>
                                    {/* Virus Identity Analysis Section */}
                                    <div style={{marginTop:12, padding:12, border:'1px solid var(--border-color)', background:'var(--bg-accent)'}}>
                                        <div style={{fontSize:'0.6rem', fontWeight:800, marginBottom:10, color:'var(--accent-color)'}}>{t('lbl_virus_analysis')}</div>
                                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8}}>
                                            <button className="btn" onClick={handleSeqTrain} disabled={seqTrainLoading} style={{fontSize:'0.65rem', padding:'8px 4px', opacity: seqTrainLoading ? 0.5 : 1}}>
                                                <i data-lucide="dna" style={{width:14, height:14}}></i> {seqTrainLoading ? '...' : t('btn_seq_analysis')}
                                            </button>
                                            <button className="btn" onClick={handleMetaTrain} disabled={metaTrainLoading} style={{fontSize:'0.65rem', padding:'8px 4px', opacity: metaTrainLoading ? 0.5 : 1}}>
                                                <i data-lucide="file-search" style={{width:14, height:14}}></i> {metaTrainLoading ? '...' : t('btn_meta_analysis')}
                                            </button>
                                        </div>
                                    </div>
                                    <button className="btn" onClick={() => handleDownload('/api/system/download/sandbox', 'sandbox')} disabled={downloading === 'sandbox'} style={{opacity: downloading === 'sandbox' ? 0.7 : 1}}>
                                        <i data-lucide={downloading === 'sandbox' ? "loader-2" : "download"} className={downloading === 'sandbox' ? "spin" : ""} style={{width:16, height:16}}></i> {downloading === 'sandbox' ? "PREPARING ZIP..." : t('btn_download_sandbox')}
                                    </button>
                                    <button className="btn" onClick={() => handleDownload('/api/system/download/database', 'db')} disabled={downloading === 'db'} style={{opacity: downloading === 'db' ? 0.7 : 1}}>
                                        <i data-lucide={downloading === 'db' ? "loader-2" : "database"} className={downloading === 'db' ? "spin" : ""} style={{width:16, height:16}}></i> {downloading === 'db' ? "EXPORTING CSV..." : t('btn_download_db')}
                                    </button>
                                    <div style={{marginTop:'auto', borderTop:'1px solid var(--border-color)', paddingTop:20}}>
                                        <button className="btn btn-danger" style={{width:'100%'}} onClick={()=>setShowResetConfirm(true)}>
                                            <i data-lucide="trash-2" style={{width:16, height:16}}></i> {t('btn_reset')}
                                        </button>
                                    </div>
                                </div>
                                <div className="log-box" style={{height:'300px', overflowY:'auto'}}>
                                    {logs.map((l,i)=><div key={i} className="log-line">&gt; {l}</div>)}
                                    {logs.length === 0 && <div style={{opacity:0.3, fontSize:'0.7rem'}}>{t('log_waiting')}</div>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Factory Reset Confirmation Modal */}
                    {showResetConfirm && (
                        <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.85)', zIndex:9999, display:'flex', alignItems:'center', justifyContent:'center'}}>
                            <div className="card" style={{width:450, maxWidth:'90%'}}>
                                <div className="card-header" style={{borderBottom:'2px solid var(--danger-color)'}}>
                                    <span className="card-title" style={{color:'var(--danger-color)'}}>{t('reset_title')}</span>
                                </div>
                                <div className="card-body">
                                    <div style={{marginBottom:20, lineHeight:1.8}}>
                                        <p style={{fontWeight:700, marginBottom:15, color:'var(--text-primary)'}}>{t('reset_warning')}</p>
                                        <ul style={{listStyle:'none', padding:0, margin:0, fontSize:'0.85rem', color:'var(--text-secondary)'}}>
                                            <li style={{padding:'6px 0', borderBottom:'1px solid var(--border-color)'}}>• {t('reset_genetic')}</li>
                                            <li style={{padding:'6px 0', borderBottom:'1px solid var(--border-color)'}}>• {t('reset_raw')}</li>
                                            <li style={{padding:'6px 0', borderBottom:'1px solid var(--border-color)'}}>• {t('reset_meta')}</li>
                                            <li style={{padding:'6px 0'}}>• {t('reset_model')}</li>
                                        </ul>
                                    </div>
                                    <div style={{background:'rgba(255,68,68,0.1)', border:'1px solid var(--danger-color)', padding:15, marginBottom:20}}>
                                        <span style={{fontSize:'0.75rem', fontWeight:800, color:'var(--danger-color)'}}>{t('reset_irreversible')}</span>
                                    </div>
                                    <div style={{display:'flex', justifyContent:'flex-end', gap:10}}>
                                        <button className="btn" onClick={()=>setShowResetConfirm(false)} disabled={isResetting}>{t('reset_cancel')}</button>
                                        <button className="btn btn-danger" style={{background:'var(--danger-color)', color:'#fff', borderColor:'var(--danger-color)'}} 
                                            onClick={async ()=>{
                                                setIsResetting(true);
                                                try {
                                                    await fetch('/api/system/reset',{method:'POST'});
                                                    location.reload();
                                                } catch(e) {
                                                    alert('초기화 실패: ' + e.message);
                                                    setIsResetting(false);
                                                }
                                            }} 
                                            disabled={isResetting}>
                                            {isResetting ? t('reset_processing') : t('reset_confirm')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const VirusPieChart = ({ data, width = 300, height = 300 }) => {
            const ref = useRef();
            
            useEffect(() => {
                if (!data || !ref.current) return;
                
                const svg = d3.select(ref.current);
                svg.selectAll("*").remove();
                
                const radius = Math.min(width, height) / 2;
                const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
                
                const color = d3.scaleOrdinal(d3.schemeCategory10);
                const pie = d3.pie().value(d => d.value);
                const arcPath = d3.arc().outerRadius(radius - 10).innerRadius(radius * 0.6);
                
                const pieData = pie(Object.entries(data).map(([k, v]) => ({ key: k, value: v })));
                
                const arc = g.selectAll(".arc")
                    .data(pieData)
                    .enter().append("g")
                    .attr("class", "arc");
                
                arc.append("path")
                    .attr("d", arcPath)
                    .attr("fill", d => color(d.data.key))
                    .attr("stroke", "var(--bg-secondary)")
                    .attr("stroke-width", "2px")
                    .transition().duration(1000).attrTween("d", function(d) {
                        const i = d3.interpolate(d.startAngle+0.1, d.endAngle);
                        return function(t) {
                            d.endAngle = i(t);
                            return arcPath(d);
                        }
                    });
                    
                // Add labels
                arc.append("text")
                    .attr("transform", d => `translate(${arcPath.centroid(d)})`)
                    .attr("dy", "0.35em")
                    .text(d => d.data.value > 0 ? d.data.key.split(' ')[0] : '')
                    .attr("text-anchor", "middle")
                    .style("fill", "#fff")
                    .style("font-size", "0.6rem")
                    .style("font-weight", "bold")
                    .style("pointer-events", "none");
                    
            }, [data, width, height]);
            
            return <svg ref={ref} width={width} height={height}></svg>;
        };

        const VirusMap = ({ data, width = 600, height = 350 }) => {
            const ref = useRef();
            const [geoData, setGeoData] = useState(null);
            
            useEffect(() => {
                // Fetch world atlas for TopoJSON
                fetch('https://unpkg.com/world-atlas@2.0.2/countries-110m.json')
                    .then(r => r.json())
                    .then(us => {
                        if (window.topojson) {
                            setGeoData(window.topojson.feature(us, us.objects.countries));
                        }
                    })
                    .catch(err => console.error("Map Data Error:", err));
            }, []);
            
            useEffect(() => {
                if (!geoData || !ref.current) return;
                
                const svg = d3.select(ref.current);
                svg.selectAll("*").remove();
                
                const projection = d3.geoMercator()
                    .scale(width / 6.5)
                    .translate([width / 2, height / 1.5]);
                    
                const path = d3.geoPath().projection(projection);
                
                const g = svg.append("g");
                
                // Draw Map
                g.selectAll("path")
                    .data(geoData.features)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("fill", "#333")
                    .attr("stroke", "#111");
                    
                // Add Points
                // Expanded coordinates map for better coverage
                const coordMap = {
                    // Asia
                    'Saudi Arabia': [45, 24], 'China': [104, 35], 'Korea': [127, 37], 'Japan': [138, 36], 
                    'Vietnam': [108, 14], 'Thailand': [100, 15], 'India': [78, 20], 'Indonesia': [113, -0.7],
                    'Taiwan': [121, 23.6], 'Malaysia': [101, 4], 'Philippines': [121, 12],
                    'Hong Kong': [114, 22], 'Singapore': [103, 1.3],
                    // Americas
                    'USA': [-95, 37], 'Canada': [-106, 56], 'Mexico': [-102, 23], 
                    'Brazil': [-51, -14], 'Argentina': [-63, -38], 'Chile': [-71, -35],
                    'New Jersey': [-74.4, 40], 'New York': [-74, 40.7], 'California': [-119, 36],
                    'Texas': [-99, 31], 'Florida': [-81, 27],
                    // Europe
                    'UK': [-3, 55], 'France': [2, 46], 'Germany': [10, 51], 'Italy': [12, 41],
                    'Spain': [-3, 40], 'Netherlands': [5, 52], 'Russia': [105, 61],
                    // Africa & Middle East
                    'Egypt': [30, 26], 'South Africa': [22, -30], 'Nigeria': [8, 9], 'Kenya': [37, 0],
                    'Iran': [53, 32], 'Turkey': [35, 38], 'Israel': [34, 31],
                    // Oceania
                    'Australia': [133, -25], 'New Zealand': [174, -40]
                };
                
                // Prepare data points
                let points = [];
                if (data) {
                    points = Object.entries(data).map(([loc, count]) => {
                        // Normalize key
                        const normLoc = loc.trim();
                        
                        // 1. Direct match
                        let coords = coordMap[normLoc];
                        
                        // 2. Case-insensitive match
                        if (!coords) {
                            const keyCI = Object.keys(coordMap).find(k => k.toLowerCase() === normLoc.toLowerCase());
                            if(keyCI) coords = coordMap[keyCI];
                        }
                        
                        // 3. Partial match (e.g. "South Korea" -> "Korea")
                        if (!coords) {
                            const keyPartial = Object.keys(coordMap).find(k => normLoc.includes(k) || k.includes(normLoc));
                            if(keyPartial) coords = coordMap[keyPartial];
                        }
                        
                        return { loc: normLoc, count, coords: coords || [0,0] };
                    }).filter(d => d.coords[0] !== 0);
                }
                
                if (points.length === 0 && Object.keys(data).length > 0) {
                    // If data exists but no coordinates found, fallback to showing a warning text on map
                    g.append("text")
                        .attr("x", width/2)
                        .attr("y", height - 20)
                        .attr("text-anchor", "middle")
                        .attr("fill", "#666")
                        .style("font-size", "0.6rem")
                        .text("SOME LOCATIONS COULD NOT BE MAPPED");
                }
                
                const maxVal = Math.max(...Object.values(data));
                const rScale = d3.scaleSqrt().domain([0, maxVal]).range([3, 15]);
                
                g.selectAll("circle")
                    .data(points)
                    .enter().append("circle")
                    .attr("cx", d => projection(d.coords)[0])
                    .attr("cy", d => projection(d.coords)[1])
                    .attr("r", 0)
                    .attr("fill", "var(--accent-color)")
                    .attr("opacity", 0.7)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("stroke", "var(--neon-green)").attr("stroke-width", 2);
                        // Simple tooltip
                        svg.append("text")
                            .attr("id", "tooltip")
                            .attr("x", projection(d.coords)[0])
                            .attr("y", projection(d.coords)[1] - 15)
                            .attr("text-anchor", "middle")
                            .attr("fill", "#fff")
                            .style("font-size", "0.7rem")
                            .style("font-weight", "bold")
                            .text(`${d.loc}: ${d.count}`);
                    })
                    .on("mouseout", function() {
                        d3.select(this).attr("stroke", "#fff").attr("stroke-width", 0.5);
                        svg.select("#tooltip").remove();
                    })
                    .transition().duration(1000)
                    .attr("r", d => rScale(d.count));
                    
            }, [data, geoData, width, height]);
            
            return <svg ref={ref} width={width} height={height} style={{background:'rgba(0,0,0,0.2)', borderRadius:8}}></svg>;
        };

        const NetworkGraph = ({ data, width = 600, height = 400 }) => {
            const mountRef = useRef(null);
            const tooltipRef = useRef(null);
            
            useEffect(() => {
                if (!mountRef.current || !data) return;
                
                // Scene setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x050505);
                
                const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.z = 30;
                
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                mountRef.current.appendChild(renderer.domElement);
                
                // Data processing for Graph
                const nodes = [];
                const hosts = Object.keys(data.host_classification || {});
                const types = Object.keys(data.virus_type_classification || {});
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1);
                pointLight.position.set(10, 10, 20);
                scene.add(pointLight);

                // Group for rotation
                const graphGroup = new THREE.Group();
                scene.add(graphGroup);

                // Nodes creation
                if (hosts.length === 0 && types.length === 0) {
                     // Placeholder when no data
                     const geo = new THREE.IcosahedronGeometry(5, 0);
                     const mat = new THREE.MeshStandardMaterial({color: 0x333333, wireframe: true});
                     graphGroup.add(new THREE.Mesh(geo, mat));
                }

                // Host Nodes (Center Cluster)
                hosts.forEach((host, i) => {
                    // Spiral distribution
                    const angle = i * 0.5;
                    const r = 3 + (i * 0.5); 
                    nodes.push({
                        id: host,
                        group: 'host',
                        x: Math.cos(angle) * r,
                        y: Math.sin(angle) * r,
                        z: (Math.random() - 0.5) * 5,
                        color: 0xff4444,
                        size: 1.2,
                        metadata: data.host_classification[host]
                    });
                });
                
                // Virus Type Nodes (Outer Shell)
                types.forEach((type, i) => {
                    const phi = Math.acos(-1 + (2 * i) / types.length);
                    const theta = Math.sqrt(types.length * Math.PI) * phi;
                    const r = 15;
                    
                    nodes.push({
                        id: type,
                        group: 'virus',
                        x: r * Math.cos(theta) * Math.sin(phi),
                        y: r * Math.sin(theta) * Math.sin(phi),
                        z: r * Math.cos(phi),
                        color: 0x4cc9f0,
                        size: 0.8,
                        metadata: data.virus_type_classification[type]
                    });
                });
                
                // Create Meshes
                const spheres = [];
                nodes.forEach(node => {
                    const geometry = new THREE.SphereGeometry(node.size, 32, 32);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: node.color, 
                        emissive: node.color,
                        emissiveIntensity: 0.4,
                        shininess: 100 
                    });
                    const sphere = new THREE.Mesh(geometry, material);
                    sphere.position.set(node.x, node.y, node.z);
                    sphere.userData = node; // Store data for interaction
                    graphGroup.add(sphere);
                    spheres.push(sphere);
                });
                
                // Links
                const materialLine = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.15 });
                const points = [];
                
                // Connect Logic: Random connections for visual effect if real relation is hard to parse dynamically
                // Or connect Host to Virus Type if they co-occur in same samples (Mock logic here)
                nodes.filter(n => n.group === 'host').forEach(h => {
                    nodes.filter(n => n.group === 'virus').forEach(v => {
                        // In a real scenario, check adjacency matrix. Here we connect randomly for visualization
                         if (Math.random() > 0.7) {
                             points.push(new THREE.Vector3(h.x, h.y, h.z));
                             points.push(new THREE.Vector3(v.x, v.y, v.z));
                         }
                    });
                });
                
                const geometryLine = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.LineSegments(geometryLine, materialLine);
                graphGroup.add(line);

                // Raycaster for Interaction
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                const onMouseMove = (event) => {
                    // Calculate mouse position in normalized device coordinates
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(spheres);
                    
                    if (intersects.length > 0) {
                        const obj = intersects[0].object;
                        const nodeData = obj.userData;
                        
                        // Show Tooltip
                        if (tooltipRef.current) {
                            tooltipRef.current.style.display = 'block';
                            tooltipRef.current.style.left = (event.clientX + 15) + 'px';
                            tooltipRef.current.style.top = (event.clientY + 15) + 'px';
                            tooltipRef.current.innerHTML = `
                                <div style="font-weight:900; color:${nodeData.group==='host'?'#ff4444':'#4cc9f0'}">${nodeData.id}</div>
                                <div style="font-size:0.7rem; color:#ccc; margin-top:4px">Type: ${nodeData.group.toUpperCase()}</div>
                                ${nodeData.metadata ? `<div style="font-size:0.6rem; color:#888; font-family:monospace; margin-top:2px">${JSON.stringify(nodeData.metadata).slice(0,50)}...</div>` : ''}
                            `;
                            document.body.style.cursor = 'pointer';
                        }
                        
                        // Highlight
                        obj.material.emissiveIntensity = 1.0;
                        obj.scale.set(1.5, 1.5, 1.5);
                    } else {
                        if (tooltipRef.current) tooltipRef.current.style.display = 'none';
                        document.body.style.cursor = 'default';
                        
                        // Reset Highlight
                        spheres.forEach(s => {
                            s.material.emissiveIntensity = 0.4;
                            s.scale.set(1, 1, 1);
                        });
                    }
                };
                
                renderer.domElement.addEventListener('mousemove', onMouseMove);

                // Animation
                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    
                    const time = Date.now() * 0.001;
                    pointLight.position.set(Math.sin(time) * 15, Math.cos(time) * 15, 10);

                    // Gentle Rotation
                    graphGroup.rotation.y += 0.002;
                    
                    renderer.render(scene, camera);
                };
                
                animate();
                
                return () => {
                    cancelAnimationFrame(frameId);
                    if (mountRef.current && renderer.domElement) {
                         renderer.domElement.removeEventListener('mousemove', onMouseMove);
                         mountRef.current.removeChild(renderer.domElement);
                    }
                    geometryLine.dispose();
                    materialLine.dispose();
                    renderer.dispose();
                };
            }, [data, width, height]);
            
            return (
                <>
                    <div ref={mountRef} style={{cursor:'default', width:'100%', height:'100%'}}></div>
                    <div ref={tooltipRef} style={{
                        position: 'fixed', 
                        background: 'rgba(0,0,0,0.9)', 
                        border: '1px solid var(--border-color)', 
                        padding: '10px', 
                        borderRadius: '4px', 
                        pointerEvents: 'none', 
                        display: 'none', 
                        zIndex: 9999,
                        fontSize: '0.8rem',
                        backdropFilter: 'blur(4px)'
                    }}></div>
                </>
            );
        };

        const StackedBarChart = ({ data, width = 500, height = 300 }) => {
            const ref = useRef();
            
            useEffect(() => {
                if (!data || !ref.current) return;
                
                const svg = d3.select(ref.current);
                svg.selectAll("*").remove();

                const margin = {top: 20, right: 30, bottom: 40, left: 40};
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                // Convert object to array
                const chartData = Object.entries(data || {}).slice(0, 10).map(([type, counts]) => ({
                    type,
                    'Type A': counts['Type A'] || 0,
                    'Type B': counts['Type B'] || 0,
                    total: (counts['Type A'] || 0) + (counts['Type B'] || 0)
                }));

                console.log("StackedBarChart Data:", chartData);
                if (chartData.length === 0) return;

                const subgroups = ['Type A', 'Type B'];
                const groups = chartData.map(d => d.type);

                const maxVal = d3.max(chartData, d => d.total) || 1;
                const x = d3.scaleBand()
                    .domain(groups)
                    .range([0, innerWidth])
                    .padding([0.2]);

                const y = d3.scaleLinear()
                    .domain([0, maxVal])
                    .range([innerHeight, 0]);

                const color = d3.scaleOrdinal()
                    .domain(subgroups)
                    .range(['#00fbff', '#ff00ff']); // Brighter colors

                const stackedData = d3.stack().keys(subgroups)(chartData);

                // Debug: Background rect for SVG area
                g.append("rect")
                    .attr("width", innerWidth)
                    .attr("height", innerHeight)
                    .attr("fill", "rgba(255,255,255,0.05)")
                    .attr("stroke", "rgba(255,255,255,0.2)");

                // Axes - Ensure white color for visibility
                g.append("g")
                    .attr("transform", `translate(0,${innerHeight})`)
                    .call(d3.axisBottom(x).tickSize(5))
                    .selectAll("text")
                        .attr("transform", "rotate(-30)")
                        .style("text-anchor", "end")
                        .style("fill", "#fff")
                        .style("font-size", "0.6rem");

                g.append("g")
                    .call(d3.axisLeft(y).ticks(5))
                    .selectAll("text")
                        .style("fill", "#fff")
                        .style("font-size", "0.6rem");

                // Bars
                const barGroups = g.append("g")
                    .selectAll("g")
                    .data(stackedData)
                    .enter().append("g")
                    .attr("fill", d => color(d.key));

                barGroups.selectAll("rect")
                    .data(d => d)
                    .enter().append("rect")
                    .attr("x", d => x(d.data.type))
                    .attr("y", d => y(d[1]))
                    .attr("height", d => Math.max(1, y(d[0]) - y(d[1]))) // minHeight 1px
                    .attr("width", Math.max(1, x.bandwidth()))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 0.5)
                    .attr("opacity", 1);
                    
            }, [data, width, height]);

            return <svg ref={ref} width={width} height={height} style={{background:'#050505', borderRadius:8}}></svg>;
        };

        const RiskBubbleChart = ({ data, width = 500, height = 300 }) => {
            const ref = useRef();

            useEffect(() => {
                if (!data || !ref.current) return;
                
                const svg = d3.select(ref.current);
                svg.selectAll("*").remove();
                
                console.log("RiskBubbleChart Data:", data);
                if (!data || data.length === 0) return;

                // Pack data
                const root = d3.hierarchy({ children: data })
                    .sum(d => d.diversity_score)
                    .sort((a, b) => b.value - a.value);

                const pack = d3.pack()
                    .size([width, height])
                    .padding(5);
                
                const rootNode = pack(root);

                const g = svg.append("g");

                console.log("RiskBubbleChart rootNode children:", rootNode.leaves().length);

                const nodes = g.selectAll("g")
                    .data(rootNode.leaves())
                    .enter().append("g")
                    .attr("transform", d => `translate(${d.x},${d.y})`);

                nodes.append("circle")
                    .attr("r", d => d.r)
                    .attr("fill", d => d.data.diversity_score > 50 ? "#ff4444" : "#4cc9f0")
                    .attr("opacity", 0.8)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1);

                nodes.append("text")
                    .selectAll("tspan")
                    .data(d => d.r > 15 ? [d.data.host, `${d.data.diversity_score}%`] : [])
                    .enter().append("tspan")
                    .attr("x", 0)
                    .attr("y", (d, i, nodes) => (i === nodes.length - 1) * 0.3 + 1.1 + i * 0.9 + "em")
                    .attr("dy", -0.5 + "em")
                    .text(d => d)
                    .attr("text-anchor", "middle")
                    .style("font-size", "0.6rem")
                    .style("fill", "#fff")
                    .style("font-weight", "bold")
                    .style("pointer-events", "none");
                    
            }, [data, width, height]);

            return <svg ref={ref} width={width} height={height}></svg>;
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{padding:20, border:'1px solid var(--danger-color)', borderRadius:8, color:'var(--danger-color)'}}>
                            <strong style={{fontSize:'0.8rem'}}>COMPONENT ERROR</strong>
                            <pre style={{fontSize:'0.6rem', marginTop:5, overflow:'auto'}}>{this.state.error?.toString()}</pre>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const StatCard = ({ title, value, meta, subValue, subLabel }) => {
            // 메타데이터 검증: meta 객체가 존재하고 비어있지 않아야 함
            const isVerified = meta && Object.values(meta).every(v => v !== null && v !== undefined);
            
            return (
                <div className="inspect-stat" style={{position:'relative', overflow:'visible', minHeight: 120}}>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom: 8}}>
                        <h4 style={{margin:0, fontSize:'0.65rem', color:'var(--text-secondary)'}}>{title}</h4>
                        {isVerified ? (
                            <i data-lucide="shield-check" style={{width:14, height:14, color:'var(--neon-green)', opacity:0.8}}></i>
                        ) : (
                            <i data-lucide="alert-triangle" style={{width:14, height:14, color:'var(--danger-color)', opacity:0.8}}></i>
                        )}
                    </div>
                    <span className="val" style={{fontSize:'1.4rem'}}>{value}</span>
                    {subValue && <div style={{fontSize:'0.6rem', color:'var(--text-secondary)', marginTop:4, fontFamily:'monospace'}}><span style={{fontWeight:800, color:'var(--accent-color)'}}>{subLabel}:</span> {subValue}</div>}
                    
                    {/* Hover Metadata Card */}
                    <div className="status-hover-panel" style={{top:'auto', bottom:'-10px', right:0, left:0, width:'100%', zIndex:100, transform:'translateY(100%)', background:'rgba(0,0,0,0.95)', border:'1px solid var(--border-color)', pointerEvents:'none'}}>
                         <div style={{fontSize:'0.6rem', fontWeight:900, marginBottom:8, color: isVerified?'var(--neon-green)':'var(--danger-color)', borderBottom:'1px solid #333', paddingBottom:5}}>
                            {isVerified ? 'DATA CONTRACT VERIFIED' : 'UNVERIFIED / MISSING META'}
                         </div>
                         {meta ? Object.entries(meta).map(([k,v]) => (
                             <div key={k} className="panel-row" style={{justifyContent:'space-between', padding:'2px 0', border: 'none'}}>
                                <span style={{opacity:0.7, fontSize:'0.55rem'}}>{k}</span>
                                <span className="panel-val" style={{maxWidth:'60%', textAlign:'right', wordBreak:'break-all', fontSize:'0.55rem', color:'#fff'}}>{String(v)}</span>
                             </div>
                         )) : <div style={{fontSize:'0.55rem', opacity:0.5}}>No Metadata Available</div>}
                    </div>
                </div>
            );
        };

        const InsightsPanel = () => {
            const { lang } = useContext(AppContext);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const fetchInsights = async () => {
                setLoading(true);
                setError(null);
                try {
                    // Parallel Fetch for Merge
                    const [resCombined, resIdentity] = await Promise.all([
                        fetch('/api/analysis/combined-insights', { method: 'POST' }),
                        fetch('/api/analysis/virus-identity', { method: 'POST' })
                    ]);
                    
                    const dCombined = await resCombined.json();
                    const dIdentity = await resIdentity.json();
                    
                    if (dCombined.status === 'success') {
                        // Merge Data
                        setData({
                            ...dCombined,
                            identity_data: dIdentity.status === 'success' ? dIdentity : {}
                        });
                    } else {
                        setError(dCombined.message);
                    }
                } catch (e) {
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchInsights(); }, []);
            useEffect(() => { lucide.createIcons(); }, [data, loading]);

            if (error) return (
                <div style={{padding:40, textAlign:'center', color:'var(--danger-color)'}}>
                    <i data-lucide="alert-triangle" style={{width:32, height:32, marginBottom:10}}></i>
                    <p style={{fontWeight:800}}>DATA PLANE ERROR</p>
                    <p style={{fontSize:'0.7rem', opacity:0.7}}>{error}</p>
                    <button className="btn" onClick={fetchInsights} style={{marginTop:20, marginInline:'auto'}}>RETRY CONNECTION</button>
                </div>
            );

            if (!data && loading) return <div style={{padding:60, textAlign:'center', opacity:0.6, fontSize:'0.8rem', fontWeight:800, color:'var(--accent-color)'}} className="pulse">INITIALIZING OBSERVATION PLANE...</div>;
            if (!data) return null;

            const stats = data.stats || {};
            const ml = data.ml_info || {};
            const obsMeta = data.observation_meta || {};
            
            return (
                <div style={{paddingBottom: 80}}>
                    {/* Header with Trust Level */}
                     <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:24}}>
                        <div>
                            <h3 style={{margin:'0 0 8px 0', fontSize:'1.1rem', fontWeight:900, letterSpacing:1}}>OBSERVATION PLANE <span style={{fontSize:'0.6rem', opacity:0.5, fontWeight:400}}> :: SYSTEM INSIGHTS</span></h3>
                            <div style={{fontSize:'0.65rem', color:'var(--text-secondary)', display:'flex', alignItems:'center', gap:15}}>
                                <span style={{display:'flex', alignItems:'center', gap:4}}>
                                    <i data-lucide="database" style={{width:10, height:10}}></i> 
                                    SNAPSHOT: <span style={{fontFamily:'monospace', color:'var(--accent-color)', fontWeight:700}}>{obsMeta.data_snapshot_hash || 'N/A'}</span>
                                </span>
                                <span style={{display:'flex', alignItems:'center', gap:4}}>
                                    <i data-lucide="shield" style={{width:10, height:10}}></i>
                                    TRUST LEVEL: <span style={{color: obsMeta.trust_level==='verified'?'var(--neon-green)':'var(--danger-color)', fontWeight:900, padding:'2px 6px', background:'rgba(255,255,255,0.05)', borderRadius:4}}>{(obsMeta.trust_level || 'UNKNOWN').toUpperCase()}</span>
                                </span>
                            </div>
                        </div>
                        <button className="btn" onClick={fetchInsights} disabled={loading}>
                            <i data-lucide={loading ? "loader-2" : "refresh-cw"} className={loading ? "spin" : ""} style={{width:14, height:14}}></i>
                            {loading ? 'SYNCING...' : 'REFRESH DATA'}
                        </button>
                    </div>

                    {/* 1. 6-Stats Grid (Data Contract Enforced) */}
                    <div className="inspect-grid" style={{gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', marginBottom: 24, padding:1, gap:1}}>
                        <StatCard 
                            title="ML ACCURACY" 
                            value={ml.accuracy ? `${ml.accuracy}%` : 'N/A'} 
                            meta={ml.meta} 
                            subValue={ml.meta?.model_version} subLabel="VER"
                        />
                        <StatCard 
                            title="F1 SCORE" 
                            value={ml.f1_score ? `${ml.f1_score}%` : 'N/A'} 
                            meta={{base_class: ml.meta?.base_class, test_size: ml.meta?.test_set_size}}
                        />
                        <StatCard 
                            title="MODEL STATUS" 
                            value={ml.model_loaded ? "ACTIVE" : "OFFLINE"} 
                            meta={{heuristic: ml.meta?.is_heuristic, simulation: ml.meta?.is_simulation}}
                        />
                         <StatCard 
                            title="TOTAL RECORDS" 
                            value={stats.total_records?.value?.toLocaleString() || 0} 
                            meta={stats.total_records?.meta}
                        />
                         <StatCard 
                            title="VIRUS TYPES" 
                            value={stats.virus_types?.value || 0} 
                            meta={stats.virus_types?.meta}
                        />
                         <StatCard 
                            title="LOCATIONS" 
                            value={stats.locations?.value || 0} 
                            meta={stats.locations?.meta}
                        />
                    </div>

                    {/* 2. Main Visuals Grid (Interactive) */}
                    <div style={{display:'grid', gridTemplateColumns: 'revert-layer', gap: 24, marginBottom: 24}}>
                        <div style={{display:'flex', gap:24, flexWrap:'wrap'}}>
                            {/* 3D Network Graph (Dominant) */}
                            <div className="card" style={{flex:'2 1 500px', height: 420, display:'flex', flexDirection:'column', overflow:'hidden'}}>
                                <div className="card-header"><span className="card-title">VIRUS-HOST NETWORK (3D)</span></div>
                                <div className="card-body" style={{flex:1, padding:0, background:'#050505', position:'relative'}}>
                                    <ErrorBoundary>
                                        <NetworkGraph data={data} width={800} height={400} />
                                    </ErrorBoundary>
                                    <div style={{position:'absolute', bottom:15, left:15, fontSize:'0.55rem', color:'rgba(255,255,255,0.3)', pointerEvents:'none', border:'1px solid rgba(255,255,255,0.1)', padding:'4px 8px'}}>
                                        INTERACTIVE WEBGL RENDER <br/> 
                                        NODES: {Object.keys(data.host_classification||{}).length + Object.keys(data.virus_type_classification||{}).length}
                                    </div>
                                </div>
                            </div>

                            {/* Right Side: Map & Pie */}
                            <div style={{flex:'1 1 300px', display:'flex', flexDirection:'column', gap: 24}}>
                                 <div className="card" style={{flex:1, display:'flex', flexDirection:'column', minHeight:200}}>
                                    <div className="card-header"><span className="card-title">GEOGRAPHICAL SPREAD</span></div>
                                    <div className="card-body" style={{flex:1, padding:0, background:'#080808', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                         <VirusMap data={data.identity_data?.distribution?.locations || {}} width={350} height={200} /> 
                                    </div>
                                 </div>
                                 <div className="card" style={{flex:1, display:'flex', flexDirection:'column', minHeight:180}}>
                                    <div className="card-header"><span className="card-title">TYPE DISTRIBUTION</span></div>
                                    <div className="card-body" style={{flex:1, display:'flex', alignItems:'center', justifyContent:'center'}}>
                                         <VirusPieChart data={data.identity_data?.distribution?.virus_types || {}} width={200} height={160} />
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    {/* 3. Analytical Deep Dive Grid */}
                    <div style={{display:'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 24}}>
                        <div className="card">
                            <div className="card-header"><span className="card-title">HOST TYPE RATIO (STACKED)</span></div>
                            <div className="card-body" style={{display:'flex', justifyContent:'center', padding:20}}>
                                <StackedBarChart data={data.virus_type_classification} width={320} height={220} />
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><span className="card-title">CROSS-SPECIES RISK (BUBBLE)</span></div>
                            <div className="card-body" style={{display:'flex', justifyContent:'center', padding:20}}>
                                <RiskBubbleChart data={data.cross_species_risk} width={320} height={220} />
                            </div>
                        </div>
                        <div className="card">
                            <div className="card-header"><span className="card-title">TEMPORAL TREND (YEARLY)</span></div>
                             <div className="card-body" style={{padding:'20px 30px'}}>
                                <div style={{display:'flex', alignItems:'flex-end', gap:8, height:220}}>
                                    {Object.entries(data.temporal_distribution || {}).map(([year, count]) => {
                                        const valArr = Object.values(data.temporal_distribution || {});
                                        const maxCount = valArr.length > 0 ? Math.max(...valArr) : 1;
                                        const hPct = (count / maxCount) * 100;
                                        return (
                                            <div key={year} style={{flex:1, display:'flex', flexDirection:'column', justifyContent:'flex-end', alignItems:'center', gap:6, height:'100%'}}>
                                                <span style={{fontSize:'0.6rem', fontWeight:800, color:'var(--accent-color)'}}>{count}</span>
                                                <div style={{width:'100%', background:'linear-gradient(to top, var(--accent-color), var(--neon-green))', height:`${hPct}%`, minHeight:2, borderRadius:'2px 2px 0 0', opacity:0.8}}></div>
                                                <span style={{fontSize:'0.6rem', fontWeight:700, color:'var(--text-secondary)'}}>{String(year)}</span>
                                            </div>
                                        );
                                    })}
                                    {(Object.keys(data.temporal_distribution || {}).length === 0) && (
                                        <div style={{width:'100%', display:'flex', alignItems:'center', justifyContent:'center', color:'var(--text-secondary)', fontSize:'0.7rem'}}>
                                            NO TEMPORAL DATA
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )
        };
        const VirusAnalysisPanel = () => {
            const { t, lang } = useContext(AppContext);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);

            const fetchAnalysis = async () => {
                setLoading(true);
                try {
                    const res = await fetch('/api/analysis/virus-identity', { method: 'POST' });
                    const d = await res.json();
                    if (d.status === 'success') setData(d);
                } catch (e) {
                    console.error('Analysis error:', e);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchAnalysis(); }, []);
            useEffect(() => { lucide.createIcons(); }, [data, loading]);

            const maxCount = data?.distribution?.virus_types ? Math.max(...Object.values(data.distribution.virus_types)) : 1;

            return (
                <div>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:20, gap:10}}>
                        <h3 style={{margin:0, fontSize:'0.8rem', fontWeight:800, lineHeight:1.4}}>{lang === 'ko' ? '바이러스 메타데이터 분포' : 'VIRUS METADATA DISTRIBUTION'}</h3>
                        <button className="btn" onClick={fetchAnalysis} disabled={loading}>
                            <i data-lucide={loading ? "loader-2" : "refresh-cw"} className={loading ? "spin" : ""} style={{width:14, height:14}}></i>
                            {loading ? '...' : (lang === 'ko' ? '새로고침' : 'REFRESH')}
                        </button>
                    </div>

                    {!data && <div style={{textAlign:'center', padding:40, opacity:0.5}}>{lang === 'ko' ? '데이터 로딩 중...' : 'LOADING DATA...'}</div>}

                    {data && (
                        <>
                            {/* Stats Grid */}
                            <div className="inspect-grid" style={{marginBottom:24}}>
                                <div className="inspect-stat">
                                    <h4>{lang === 'ko' ? '총 레코드' : 'TOTAL_RECORDS'}</h4>
                                    <span className="val">{(data.total_records || 0).toLocaleString()}</span>
                                </div>
                                <div className="inspect-stat">
                                    <h4>{lang === 'ko' ? '동일 시퀀스 그룹' : 'IDENTICAL_GROUPS'}</h4>
                                    <span className="val">{(data.identical_groups || 0).toLocaleString()}</span>
                                </div>
                                <div className="inspect-stat">
                                    <h4>{lang === 'ko' ? '바이러스 타입' : 'VIRUS_TYPES'}</h4>
                                    <span className="val">{Object.keys(data.distribution?.virus_types || {}).length}</span>
                                </div>
                                <div className="inspect-stat">
                                    <h4>{lang === 'ko' ? '지역' : 'LOCATIONS'}</h4>
                                    <span className="val">{Object.keys(data.distribution?.locations || {}).length}</span>
                                </div>
                            </div>
                            
                            {/* D3 Visualizations */}
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1.5fr', gap:20, marginBottom:24}}>
                                {/* Pie Chart */}
                                <div className="card" style={{display:'flex', flexDirection:'column'}}>
                                    <div className="card-header"><span className="card-title">{lang === 'ko' ? '타입 비율 (D3)' : 'TYPE RATIO (D3)'}</span></div>
                                    <div className="card-body" style={{flex:1, display:'flex', alignItems:'center', justifyContent:'center', padding:10}}>
                                        <VirusPieChart data={data.distribution.virus_types} width={280} height={280} />
                                    </div>
                                </div>
                                
                                {/* Map */}
                                <div className="card" style={{display:'flex', flexDirection:'column'}}>
                                    <div className="card-header"><span className="card-title">{lang === 'ko' ? '지역별 발생 지도 (D3)' : 'GEOGRAPHICAL MAP (D3)'}</span></div>
                                    <div className="card-body" style={{flex:1, display:'flex', alignItems:'center', justifyContent:'center', padding:0, background:'#000'}}>
                                        <VirusMap data={data.distribution.locations} width={500} height={300} />
                                    </div>
                                </div>
                            </div>

                            {/* Virus Type Distribution Linear (Legacy) & Top Identical */}
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:20}}>
                                {/* Virus Type Distribution Chart (Bar) */}
                                <div className="card" style={{marginBottom:20}}>
                                    <div className="card-header">
                                        <span className="card-title">{lang === 'ko' ? '상세 분포' : 'DETAILED DISTRIBUTION'}</span>
                                    </div>
                                    <div className="card-body">
                                        <div style={{display:'flex', flexDirection:'column', gap:8}}>
                                            {Object.entries(data.distribution?.virus_types || {}).map(([type, count]) => (
                                                <div key={type} style={{display:'flex', alignItems:'center', gap:10}}>
                                                    <span style={{minWidth:140, fontSize:'0.65rem', fontWeight:700, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{type}</span>
                                                    <div style={{flex:1, height:16, background:'var(--bg-accent)', border:'1px solid var(--border-color)'}}>
                                                        <div style={{width:`${(count / maxCount) * 100}%`, height:'100%', background:'var(--accent-color)', transition:'width 0.3s'}}></div>
                                                    </div>
                                                    <span style={{minWidth:40, textAlign:'right', fontSize:'0.65rem', fontWeight:800}}>{count.toLocaleString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Top Identical Sequences */}
                                <div className="card" style={{marginBottom:20}}>
                                    <div className="card-header"><span className="card-title">{lang === 'ko' ? '다중 발생 시퀀스' : 'MULTI-OCCURRENCE SEQS'}</span></div>
                                    <div className="card-body" style={{padding:0}}>
                                        <table style={{width:'100%', fontSize:'0.65rem', borderCollapse:'collapse'}}>
                                            <thead>
                                                <tr style={{background:'var(--bg-accent)'}}>
                                                    <th style={{padding:'8px 12px', textAlign:'left'}}>{lang === 'ko' ? '시퀀스 미리보기' : 'SEQUENCE PREVIEW'}</th>
                                                    <th style={{padding:'8px 12px', textAlign:'right'}}>{lang === 'ko' ? '횟수' : 'COUNT'}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(data.top_identical || []).slice(0, 8).map((item, idx) => (
                                                    <tr key={idx} style={{borderBottom:'1px solid var(--border-color)'}}>
                                                        <td style={{padding:'8px 12px', fontFamily:'monospace', fontSize:'0.55rem', wordBreak:'break-all'}}>{item.sequence_preview}</td>
                                                        <td style={{padding:'8px 12px', textAlign:'right', fontWeight:800, color:'var(--accent-color)'}}>{item.occurrence_count}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const NeuralPanel = () => {
            const { t, theme } = useContext(AppContext);
            const [data, setData] = useState(null);
            const [seqData, setSeqData] = useState(null);
            const [downloading, setDownloading] = useState(false);

            useEffect(() => { 
                fetch('/api/ml/inspect').then(r => r.json()).then(setData); 
                fetch('/api/ml/sequence-inspect').then(r => r.json()).then(d => {
                    if (d.status === 'success') setSeqData(d);
                }).catch(() => {});
            }, []);
            
            const handleDownload = () => {
                setDownloading(true);
                setTimeout(() => {
                    window.location.href = '/api/ml/download/report';
                    setTimeout(() => setDownloading(false), 3000);
                }, 500);
            };

            useEffect(() => { 
                lucide.createIcons(); 
            }, [data, downloading]); // downloading 변경 시 아이콘 재생성

            if (!data) return <div style={{opacity:0.5, textAlign:'center', padding:50}}>{t('neural_syncing')}</div>;
            
            // Error state handling
            if (data.error || !data.info) {
                return (
                    <div style={{padding:40, textAlign:'center', color:'var(--danger-color)'}}>
                        <i data-lucide="alert-triangle" style={{width:32, height:32, marginBottom:10}}></i>
                        <p style={{fontWeight:800}}>MODEL INSPECTION ERROR</p>
                        <p style={{fontSize:'0.7rem', opacity:0.7}}>{data.error || 'Model info not available.'}</p>
                        <button className="btn" onClick={() => fetch('/api/ml/inspect').then(r => r.json()).then(setData)} style={{marginTop:20}}>RETRY</button>
                    </div>
                );
            }
            
            const info = data.info || {};
            const metrics = data.training_metrics;
            const cm = metrics?.confusion_matrix;
            
            // Confusion Matrix 셀 색상 계산
            const getCMColor = (value, max) => {
                const intensity = max > 0 ? value / max : 0;
                return `rgba(124, 77, 255, ${0.2 + intensity * 0.8})`;
            };
            const cmMax = cm ? Math.max(...cm.flat()) : 1;
            
            return (
                <div>
                    {/* PDF Download Button */}
                    <div style={{marginBottom:24, display:'flex', justifyContent:'flex-end'}}>
                        <button className="btn btn-accent" onClick={handleDownload} disabled={downloading} style={{opacity: downloading ? 0.7 : 1}}>
                            <i data-lucide={downloading ? "loader-2" : "file-down"} className={downloading ? "spin" : ""} style={{width:16, height:16}}></i> {downloading ? "GENERATING PDF..." : t('btn_download_pdf')}
                        </button>
                    </div>
                    
                    {/* Stats Grid */}
                    <div className="inspect-grid">
                        <div className="inspect-stat">
                            <h4>{t('neural_algo')}</h4>
                            <span className="val">{info.algorithm || 'N/A'}</span>
                            <div className="val-tags">
                                <span className="val-tag active">N_EST: {info.n_estimators || 50}</span>
                                <span className="val-tag active">DEPTH: {info.max_depth || 'AUTO'}</span>
                                <span className="val-tag success">{t('neural_sync')}</span>
                            </div>
                        </div>
                        <div className="inspect-stat">
                            <h4>{t('neural_vector')}</h4>
                            <span className="val">{info.total_features || 0}</span>
                            <div className="val-tags">
                                {(info.classes || []).map(c => <span key={c} className="val-tag active">{c}</span>)}
                                <span className="val-tag success">{t('neural_classifying')}</span>
                            </div>
                        </div>
                        {metrics && (
                            <>
                                <div className="inspect-stat">
                                    <h4>{t('neural_accuracy')}</h4>
                                    <span className="val" style={{color: metrics.accuracy >= 0.8 ? 'var(--neon-green)' : 'var(--accent-color)'}}>{(metrics.accuracy * 100).toFixed(1)}%</span>
                                    <div className="val-tags">
                                        <span className="val-tag">{t('neural_train')}: {metrics.train_size}</span>
                                        <span className="val-tag">{t('neural_test')}: {metrics.test_size}</span>
                                    </div>
                                </div>
                                <div className="inspect-stat">
                                    <h4>{t('neural_f1')}</h4>
                                    <span className="val">{(metrics.f1_score * 100).toFixed(1)}%</span>
                                    <div className="val-tags">
                                        <span className="val-tag">{t('neural_precision')}: {(metrics.precision * 100).toFixed(0)}%</span>
                                        <span className="val-tag">{t('neural_recall')}: {(metrics.recall * 100).toFixed(0)}%</span>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                    
                    {/* Confusion Matrix & Confidence Distribution */}
                    {metrics && cm && (
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:24, marginBottom:24}}>
                            <div className="card">
                                <div className="card-header"><span className="card-title">{t('neural_confusion')}</span></div>
                                <div className="card-body" style={{display:'flex', justifyContent:'center'}}>
                                    <div style={{display:'grid', gridTemplateColumns:'60px 1fr 1fr', gridTemplateRows:'auto 1fr 1fr', gap:2, width:'fit-content'}}>
                                        <div></div>
                                        <div style={{textAlign:'center', fontSize:'0.6rem', fontWeight:800, color:'var(--accent-color)', padding:8}}>{t('neural_pred_a')}</div>
                                        <div style={{textAlign:'center', fontSize:'0.6rem', fontWeight:800, color:'var(--accent-color)', padding:8}}>{t('neural_pred_b')}</div>
                                        
                                        <div style={{display:'flex', alignItems:'center', fontSize:'0.6rem', fontWeight:800, color:'var(--text-secondary)'}}>{t('neural_true_a')}</div>
                                        <div style={{width:80, height:60, display:'flex', alignItems:'center', justifyContent:'center', background:getCMColor(cm[0][0], cmMax), border:'1px solid var(--border-color)', fontSize:'1.5rem', fontWeight:900, color:'var(--text-primary)'}}>{cm[0][0]}</div>
                                        <div style={{width:80, height:60, display:'flex', alignItems:'center', justifyContent:'center', background:getCMColor(cm[0][1], cmMax), border:'1px solid var(--border-color)', fontSize:'1.5rem', fontWeight:900, color: cm[0][1] > 0 ? 'var(--danger-color)' : 'var(--text-secondary)'}}>{cm[0][1]}</div>
                                        
                                        <div style={{display:'flex', alignItems:'center', fontSize:'0.6rem', fontWeight:800, color:'var(--text-secondary)'}}>{t('neural_true_b')}</div>
                                        <div style={{width:80, height:60, display:'flex', alignItems:'center', justifyContent:'center', background:getCMColor(cm[1][0], cmMax), border:'1px solid var(--border-color)', fontSize:'1.5rem', fontWeight:900, color: cm[1][0] > 0 ? 'var(--danger-color)' : 'var(--text-secondary)'}}>{cm[1][0]}</div>
                                        <div style={{width:80, height:60, display:'flex', alignItems:'center', justifyContent:'center', background:getCMColor(cm[1][1], cmMax), border:'1px solid var(--border-color)', fontSize:'1.5rem', fontWeight:900, color:'var(--text-primary)'}}>{cm[1][1]}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="card">
                                <div className="card-header"><span className="card-title">{t('neural_confidence')}</span></div>
                                <div className="card-body">
                                    <div style={{marginBottom:15}}>
                                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:5}}>
                                            <span style={{fontSize:'0.7rem', fontWeight:700, color:'var(--neon-green)'}}>{t('neural_high')}</span>
                                            <span style={{fontSize:'0.8rem', fontWeight:800}}>{metrics.confidence_distribution.high}</span>
                                        </div>
                                        <div style={{height:20, background:'var(--bg-accent)', border:'1px solid var(--border-color)'}}>
                                            <div style={{height:'100%', width:`${(metrics.confidence_distribution.high / metrics.test_size) * 100}%`, background:'var(--neon-green)'}}></div>
                                        </div>
                                    </div>
                                    <div style={{marginBottom:15}}>
                                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:5}}>
                                            <span style={{fontSize:'0.7rem', fontWeight:700, color:'var(--accent-color)'}}>{t('neural_medium')}</span>
                                            <span style={{fontSize:'0.8rem', fontWeight:800}}>{metrics.confidence_distribution.medium}</span>
                                        </div>
                                        <div style={{height:20, background:'var(--bg-accent)', border:'1px solid var(--border-color)'}}>
                                            <div style={{height:'100%', width:`${(metrics.confidence_distribution.medium / metrics.test_size) * 100}%`, background:'var(--accent-color)'}}></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:5}}>
                                            <span style={{fontSize:'0.7rem', fontWeight:700, color:'var(--danger-color)'}}>{t('neural_low')}</span>
                                            <span style={{fontSize:'0.8rem', fontWeight:800}}>{metrics.confidence_distribution.low}</span>
                                        </div>
                                        <div style={{height:20, background:'var(--bg-accent)', border:'1px solid var(--border-color)'}}>
                                            <div style={{height:'100%', width:`${(metrics.confidence_distribution.low / metrics.test_size) * 100}%`, background:'var(--danger-color)'}}></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Feature Importance */}
                    <div className="card">
                        <div className="card-header"><span className="card-title">{t('neural_features')}</span></div>
                        <div className="card-body">
                            {data.top_features.slice(0,10).map((f, i) => (
                                <div key={i} className="bar-container">
                                    <div className="bar-label" style={{color: i < 3 ? 'var(--accent-color)' : 'var(--text-secondary)'}}>{f.name}</div>
                                    <div className="bar-wrapper"><div className="bar-fill" style={{width: `${f.weight * 500}%`, background: i < 3 ? 'var(--accent-color)' : 'var(--text-secondary)'}}></div></div>
                                    <div style={{width:80, fontSize:'0.8rem', textAlign:'right', fontWeight:800, color: i < 3 ? 'var(--accent-color)' : 'var(--text-secondary)'}}>{(f.weight*100).toFixed(2)}%</div>
                                </div>
                            ))}
                            
                            {data.extra_feature_names && data.extra_feature_names.length > 0 && (
                                <div style={{marginTop:30, borderTop:'1px solid var(--border-color)', paddingTop:20}}>
                                    <h4 style={{fontSize:'0.65rem', marginBottom:15, color:'var(--text-secondary)', fontWeight:800}}>{t('neural_extended')} ({data.info.total_features} {t('neural_dimensions')})</h4>
                                    <div className="val-tags">
                                        {data.extra_feature_names.slice(0, 20).map(name => (
                                            <span key={name} className="val-tag">{name}</span>
                                        ))}
                                        {data.extra_feature_names.length > 20 && <span className="val-tag">+{data.extra_feature_names.length - 20} {t('neural_more')}</span>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Sequence Model Results */}
                    <div className="card" style={{marginTop:24}}>
                        <div className="card-header">
                            <span className="card-title"><i data-lucide="dna" style={{width:16, height:16, marginRight:8}}></i> SEQUENCE MODEL (바이러스 타입 분류)</span>
                        </div>
                        <div className="card-body">
                            {!seqData && (
                                <div style={{textAlign:'center', padding:30, opacity:0.5}}>
                                    <p style={{marginBottom:10}}>시퀀스 모델이 아직 학습되지 않았습니다.</p>
                                    <p style={{fontSize:'0.7rem'}}>제어판에서 "시퀀스 학습" 버튼을 클릭하세요.</p>
                                </div>
                            )}
                            {seqData && (
                                <div>
                                    <div className="inspect-grid" style={{marginBottom:20}}>
                                        <div className="inspect-stat">
                                            <h4>Algorithm</h4>
                                            <span className="val">{seqData.model_type}</span>
                                            <div className="val-tags">
                                                <span className="val-tag active">FEATURES: {seqData.feature_count}</span>
                                            </div>
                                        </div>
                                        <div className="inspect-stat">
                                            <h4>Accuracy</h4>
                                            <span className="val" style={{color: seqData.accuracy >= 0.7 ? 'var(--neon-green)' : 'var(--accent-color)'}}>{(seqData.accuracy * 100).toFixed(1)}%</span>
                                            <div className="val-tags">
                                                <span className="val-tag">TRAIN: {seqData.train_size}</span>
                                                <span className="val-tag">TEST: {seqData.test_size}</span>
                                            </div>
                                        </div>
                                        <div className="inspect-stat">
                                            <h4>F1 Score</h4>
                                            <span className="val">{(seqData.f1_score * 100).toFixed(1)}%</span>
                                        </div>
                                        <div className="inspect-stat">
                                            <h4>Classes</h4>
                                            <span className="val">{seqData.labels?.length || 0}</span>
                                            <div className="val-tags">
                                                {seqData.labels?.slice(0, 4).map(l => (
                                                    <span key={l} className="val-tag active">{l}</span>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {seqData.label_distribution && (
                                        <div style={{borderTop:'1px solid var(--border-color)', paddingTop:15}}>
                                            <h4 style={{fontSize:'0.65rem', marginBottom:10, color:'var(--text-secondary)', fontWeight:800}}>Label Distribution</h4>
                                            <div style={{display:'flex', gap:10, flexWrap:'wrap'}}>
                                                {Object.entries(seqData.label_distribution).map(([label, count]) => (
                                                    <div key={label} style={{padding:'8px 12px', background:'var(--bg-accent)', border:'1px solid var(--border-color)', fontSize:'0.7rem'}}>
                                                        <span style={{color:'var(--accent-color)', fontWeight:700}}>{label}</span>: {count}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {seqData.trained_at && (
                                        <div style={{marginTop:15, fontSize:'0.6rem', color:'var(--text-secondary)'}}>
                                            Trained: {new Date(seqData.trained_at).toLocaleString()}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ========== SIMULATION PANEL ==========
        const SimulationPanel = () => {
            const { t } = useContext(AppContext);
            const [running, setRunning] = useState(false);
            const [speed, setSpeed] = useState(100);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [sequences, setSequences] = useState([]);
            const [visiblePoints, setVisiblePoints] = useState([]);
            const [totalRecords, setTotalRecords] = useState(0);
            const [mutations, setMutations] = useState([]);
            const [recentEvents, setRecentEvents] = useState([]); // Live event stream
            const intervalRef = useRef(null);
            
            const coordMap = {
                // North America
                'USA': [-95, 37], 'New York': [-74, 40.7], 'New Jersey': [-74.4, 40.1], 
                'California': [-119, 36], 'Texas': [-99, 31], 'Florida': [-81, 27], 'Washington': [-120, 47], 'Illinois': [-89, 40],
                'Canada': [-106, 56], 'Mexico': [-102, 23],
                
                // South America
                'Brazil': [-55, -10], 'Argentina': [-63, -38], 'Chile': [-71, -35], 
                'Colombia': [-74, 4], 'Peru': [-75, -9],
                
                // Europe
                'UK': [-3, 55], 'France': [2, 46], 'Germany': [10, 51], 'Italy': [12, 41],
                'Spain': [-3, 40], 'Netherlands': [5, 52], 'Russia': [105, 61], 
                'Switzerland': [8, 46], 'Sweden': [18, 60], 'Norway': [8, 60],
                
                // Asia
                'China': [105, 35], 'Japan': [138, 36], 'Korea': [127, 37], 'South Korea': [127, 37],
                'India': [78, 20], 'Vietnam': [108, 16], 'Thailand': [100, 15], 
                'Malaysia': [101, 4], 'Singapore': [103, 1.3], 'Indonesia': [113, -0.7], 
                'Philippines': [121, 12], 'Taiwan': [121, 23.6], 'Hong Kong': [114, 22],
                
                // Middle East
                'Israel': [34, 31], 'Iran': [53, 32], 'Turkey': [35, 38], 
                'UAE': [53, 23], 'Saudi Arabia': [45, 24], 'Egypt': [30, 27],
                
                // Africa
                'South Africa': [22, -30], 'Nigeria': [8, 9], 'Kenya': [37, 0], 'Ethiopia': [40, 9],
                
                // Oceania
                'Australia': [133, -25], 'New Zealand': [174, -40]
            };
            
            useEffect(() => {
                fetch('/api/analysis/simulation/sequences').then(r => r.json()).then(d => {
                    if (d.status === 'success') {
                        setSequences(d.sequences);
                        setTotalRecords(d.total);
                    }
                }).catch(() => {});
            }, []);
            
            useEffect(() => {
                if (running && totalRecords > 0) {
                    intervalRef.current = setInterval(() => {
                        setCurrentIndex(prev => {
                            const next = Math.min(prev + 10, totalRecords);
                            const newSeqs = sequences.slice(prev, next);
                            
                            // 1. Update Map Points
                            setVisiblePoints(p => {
                                const pointsToAdd = next - prev;
                                const newPoints = [];
                                for (let i = 0; i < pointsToAdd; i++) {
                                    const s = newSeqs[i] || {};
                                    let loc = (s.location || 'Unknown').trim();
                                    
                                    // Matching Logic (Exact -> Case-Insensitive -> Partial)
                                    let coords = coordMap[loc];
                                    if (!coords) {
                                        const foundKey = Object.keys(coordMap).find(k => k.toLowerCase() === loc.toLowerCase());
                                        if (foundKey) coords = coordMap[foundKey];
                                    }
                                    if (!coords) {
                                         const foundKey = Object.keys(coordMap).find(k => loc.includes(k) || k.includes(loc));
                                         if (foundKey) coords = coordMap[foundKey];
                                    }

                                    // If coords found, add point. If not, skip (don't show default/Africa)
                                    if (coords) {
                                        newPoints.push({
                                            id: prev + i,
                                            // Drastically reduced jitter from 15 to 1.5/1.0
                                            x: coords[0] + (Math.random() - 0.5) * 1.5,
                                            y: coords[1] + (Math.random() - 0.5) * 1.5,
                                            type: s.virus_type || 'Unknown',
                                            size: 0.5 + Math.random() * 1
                                        });
                                    }
                                }
                                // Keep only last 2000 points to create a "trailing" effect (persistence)
                                const combined = [...p, ...newPoints];
                                return combined.length > 2000 ? combined.slice(-2000) : combined;
                            });

                            // 2. Update Event Stream (Take last 5 new items to avoid spam)
                            const newEvents = newSeqs.slice(-5).map(s => ({
                                id: s.id,
                                loc: s.location || 'Unknown',
                                type: s.virus_type || 'Unknown',
                                time: new Date(s.birth_time).toLocaleTimeString()
                            })).reverse();
                            
                            setRecentEvents(prev => [...newEvents, ...prev].slice(0, 50)); // Keep last 50 events

                            if (Math.random() < 0.05 && next > 10) {
                                setMutations(m => [...m, { id: Date.now(), type: Math.random() > 0.5 ? 'A→B' : 'B→A' }]);
                            }
                            if (next >= totalRecords) setRunning(false);
                            return next;
                        });
                    }, speed);
                }
                return () => clearInterval(intervalRef.current);
            }, [running, sequences, speed, totalRecords]);
            
            const handleReset = () => { setRunning(false); setCurrentIndex(0); setVisiblePoints([]); setMutations([]); setRecentEvents([]); };
            
            useEffect(() => { lucide.createIcons(); }, [running]);
            
            return (
                <div>
                    <div className="card" style={{marginBottom:24}}>
                        <div className="card-header"><span className="card-title"><i data-lucide="play-circle" style={{width:16, height:16, marginRight:8}}></i> VIRUS SPREAD SIMULATION</span></div>
                        <div className="card-body">
                            <div style={{display:'flex', gap:20, alignItems:'center', marginBottom:20}}>
                                <button className={`btn ${running ? 'btn-danger' : 'btn-accent'}`} onClick={() => setRunning(!running)} disabled={sequences.length === 0}>
                                    <i data-lucide={running ? 'pause' : 'play'} style={{width:16, height:16}}></i> {running ? 'PAUSE' : 'START'}
                                </button>
                                <button className="btn" onClick={handleReset}><i data-lucide="rotate-ccw" style={{width:16, height:16}}></i> RESET</button>
                                <div style={{flex:1}}>
                                    <label style={{fontSize:'0.7rem', marginBottom:5, display:'block'}}>Speed: {speed}ms (Lower is Faster)</label>
                                    <input type="range" min="1" max="1000" step="1" value={speed} onChange={e => setSpeed(Number(e.target.value))} style={{width:'100%'}} />
                                </div>
                            </div>
                            <div className="inspect-grid">
                                <div className="inspect-stat"><h4>Progress</h4><span className="val">{currentIndex} / {totalRecords}</span></div>
                                <div className="inspect-stat"><h4>Visible Points</h4><span className="val" style={{color:'var(--accent-color)'}}>{visiblePoints.length}</span></div>
                                <div className="inspect-stat"><h4>Mutations</h4><span className="val" style={{color:'var(--danger-color)'}}>{mutations.length}</span></div>
                                <div className="inspect-stat"><h4>Live Events</h4><span className="val" style={{color:'var(--neon-green)'}}>{recentEvents.length}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Split View: Map (80%) | List (20%) */}
                    <div className="card">
                        <div className="card-header"><span className="card-title">WORLD MAP - Live Spread</span></div>
                        <div className="card-body" style={{height:500, padding:0, display:'flex', overflow:'hidden'}}>
                            {/* Map Area */}
                            <div style={{flex:4, position:'relative', borderRight:'1px solid var(--border-color)'}}>
                                <SimulationMap points={visiblePoints} />
                            </div>
                            
                            {/* Metadata Stream Area */}
                            <div style={{flex:1, background:'var(--bg-secondary)', display:'flex', flexDirection:'column'}}>
                                <div style={{padding:'10px 15px', borderBottom:'1px solid var(--border-color)', fontSize:'0.7rem', fontWeight:800, color:'var(--text-secondary)', background:'rgba(0,0,0,0.2)'}}>
                                    LIVE FEED ({recentEvents.length})
                                </div>
                                <div style={{flex:1, overflowY:'hidden', padding:0}}> {/* Hidden overflow for "stream" feel */}
                                    <div style={{display:'flex', flexDirection:'column'}}>
                                        {recentEvents.map((evt, idx) => (
                                            <div key={`${evt.id}-${idx}`} style={{
                                                padding:'8px 15px', 
                                                borderBottom:'1px solid var(--border-color)', 
                                                fontSize:'0.65rem',
                                                animation: 'slideIn 0.3s ease-out'
                                            }}>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:2}}>
                                                    <span style={{fontWeight:800, color:'var(--accent-color)'}}>{evt.loc}</span>
                                                    <span style={{opacity:0.5, fontSize:'0.55rem'}}>{evt.time}</span>
                                                </div>
                                                <div style={{color:'var(--text-secondary)'}}>{evt.type}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {/* CSS for slide-in animation */}
                                <style>{`
                                    @keyframes slideIn {
                                        from { opacity: 0; transform: translateY(-10px); }
                                        to { opacity: 1; transform: translateY(0); }
                                    }
                                `}</style>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const SimulationMap = ({ points }) => {
            const svgRef = useRef();
            const [geoData, setGeoData] = useState(null);
            
            useEffect(() => {
                fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                    .then(r => r.json())
                    .then(data => setGeoData(topojson.feature(data, data.objects.countries)));
            }, []);
            
            useEffect(() => {
                if (!geoData || !svgRef.current) return;
                const svg = d3.select(svgRef.current);
                svg.selectAll('*').remove();
                const width = svgRef.current.clientWidth || 800;
                const height = svgRef.current.clientHeight || 500;
                const projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width / 2, height / 2]);
                const pathGen = d3.geoPath().projection(projection);
                
                svg.append('g').selectAll('path').data(geoData.features).enter().append('path')
                    .attr('d', pathGen).attr('fill', 'var(--bg-accent)').attr('stroke', 'var(--border-color)').attr('stroke-width', 0.5);
                
                const pointsGroup = svg.append('g');
                points.forEach((p, i) => {
                    const [px, py] = projection([p.x, p.y]) || [0, 0];
                    
                    // Opacity calc: Non-linear fade.
                    // Oldest points stay VERY faint (0.02) to blend with background.
                    // Only the newest points get distinct brightness.
                    const ratio = (i + 1) / points.length;
                    const opacity = Math.max(0.02, Math.pow(ratio, 3) * 0.8);
                    
                    pointsGroup.append('circle').attr('cx', px).attr('cy', py).attr('r', p.size)
                        .attr('fill', p.type.includes('Influenza') ? `rgba(255, 100, 100, ${opacity})` : `rgba(100, 200, 255, ${opacity})`)
                        .attr('stroke', 'none'); 
                });
            }, [geoData, points]);
            
            return <svg ref={svgRef} style={{width:'100%', height:'100%', background:'var(--bg-primary)'}} />;
        };

        const SettingsPanel = () => {
            const { t, theme, setTheme, sysMode, setSysMode, lang, setLang } = useContext(AppContext);
            
            const [apiKey, setApiKey] = useState('');
            const [isConfigured, setIsConfigured] = useState(false);
            
            useEffect(() => {
                fetch('/api/system/config').then(r=>r.json()).then(res => {
                    if(res.status==='success') {
                         setApiKey(res.config.gemini_api_key);
                         setIsConfigured(res.config.is_configured);
                    }
                });
            }, []);
            
            const handleSaveKey = () => {
                fetch('/api/system/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ gemini_api_key: apiKey })
                }).then(r=>r.json()).then(res => {
                    if(res.status==='success') {
                        alert('API Key Saved Successfully');
                        setIsConfigured(true);
                    } else {
                        alert(res.message);
                    }
                });
            };

            return (
                <div className="card">
                    <div className="card-header"><span className="card-title">{t('settings_title')}</span></div>
                    <div className="card-body">
                        <div style={{marginBottom:45}}>
                            <h4 style={{fontSize:'0.65rem', marginBottom:20, color:'var(--text-secondary)', fontWeight:800, letterSpacing:1}}>{t('lbl_lang')}</h4>
                            <div className="mode-switcher">
                                <button className={`mode-btn ${lang==='en'?'active':''}`} onClick={()=>setLang('en')}>ENG</button>
                                <button className={`mode-btn ${lang==='ko'?'active':''}`} onClick={()=>setLang('ko')}>KOR</button>
                            </div>
                        </div>
                        
                        <div style={{marginBottom:45}}>
                            <h4 style={{fontSize:'0.65rem', marginBottom:20, color:'var(--text-secondary)', fontWeight:800, letterSpacing:1}}>AI MODEL API KEY</h4>
                            <div style={{display:'flex', gap:10}}>
                                 <input 
                                     type="password" 
                                     value={apiKey} 
                                     onChange={e=>setApiKey(e.target.value)} 
                                     placeholder={isConfigured ? "API Key Configured (Hidden)" : "Enter Gemini API Key (sk-...)"}
                                     style={{flex:1, background: 'rgba(255,255,255,0.05)', border:'1px solid var(--border-color)', padding: '10px 15px', color:'var(--text-primary)', borderRadius:4, outline:'none', fontSize:'0.8rem'}}
                                 />
                                 <button className="btn btn-primary" onClick={handleSaveKey} style={{padding:'0 20px'}}>SAVE</button>
                            </div>
                            <div style={{fontSize:'0.7rem', opacity:0.6, marginTop:8, display:'flex', alignItems:'center', gap:5}}>
                                {isConfigured ? <><LucideIcon name="check-circle" size={12} style={{color:'var(--success-color)'}}/> API Key is securely stored.</> : "⚠️ API Key is required for Document Enhance features."}
                            </div>
                        </div>

                        <div style={{marginBottom:45}}>
                            <h4 style={{fontSize:'0.65rem', marginBottom:20, color:'var(--text-secondary)', fontWeight:800, letterSpacing:1}}>{t('lbl_mode')}</h4>
                            <div className="mode-switcher">
                                <button className={`mode-btn ${sysMode==='light'?'active':''}`} onClick={()=>setSysMode('light')}>{t('mode_light')}</button>
                                <button className={`mode-btn ${sysMode==='dark'?'active':''}`} onClick={()=>setSysMode('dark')}>{t('mode_dark')}</button>
                            </div>
                        </div>
                        <div style={{marginBottom:45}}>
                            <h4 style={{fontSize:'0.65rem', marginBottom:20, color:'var(--text-secondary)', fontWeight:800, letterSpacing:1}}>{t('lbl_theme')}</h4>
                            <div className="settings-grid">
                                {THEMES.map(th => (
                                    <div key={th.id} className={`theme-item ${theme === th.id ? 'active' : ''}`} onClick={()=>setTheme(th.id)}>
                                        <div className="theme-preview" style={{background:th.color}}></div>
                                        <span style={{fontSize:'0.6rem', fontWeight:800}}>{th.name}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DatabasePanel = () => {
            const [resp, setResp] = useState(null);
            const [page, setPage] = useState(1);
            const [perPage, setPerPage] = useState(20);
            const [loading, setLoading] = useState(false);

            useEffect(() => { 
                setLoading(true);
                fetch(`/api/database/tables/genetic_records?page=${page}&per_page=${perPage}`)
                    .then(r=>r.json())
                    .then(d => { setResp(d); setLoading(false); }); 
            }, [page, perPage]);

            if(!resp) return null;

            const totalRows = resp.pagination?.total_rows || 0;
            const totalPages = resp.pagination?.total_pages || 1;
            
            const renderPageButtons = () => {
                const buttons = [];
                let startPage = Math.max(1, page - 2);
                let endPage = Math.min(totalPages, page + 2);
                
                if (startPage > 1) {
                    buttons.push(<button key={1} className="page-btn" onClick={()=>setPage(1)}>1</button>);
                    if (startPage > 2) buttons.push(<span key="e1">...</span>);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    buttons.push(<button key={i} className={`page-btn ${page===i?'active':''}`} onClick={()=>setPage(i)}>{i}</button>);
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) buttons.push(<span key="e2">...</span>);
                    buttons.push(<button key={totalPages} className="page-btn" onClick={()=>setPage(totalPages)}>{totalPages}</button>);
                }
                return buttons;
            };

            return (
                <div className="card">
                    <div className="card-header" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                        <span className="card-title">{t('db_title')} ({totalRows.toLocaleString()})</span>
                        <div style={{display:'flex', gap:10, alignItems:'center'}}>
                            <span style={{fontSize:'0.6rem', fontWeight:800, color:'var(--text-secondary)'}}>{t('db_limit')}</span>
                            <select className="type-toggle-btn" style={{padding:'2px 8px', height:24, fontSize:'0.6rem'}} value={perPage} onChange={(e)=>{setPerPage(Number(e.target.value)); setPage(1);}}>
                                <option value={10}>10</option>
                                <option value={20}>20</option>
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                            </select>
                        </div>
                    </div>
                    <div className="card-body" style={{padding:0, position:'relative'}}>
                        {loading && <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.3)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:10, fontSize:'0.7rem', fontWeight:900, color:'var(--accent-color)'}}>{t('db_loading')}</div>}
                        <table className="db-table" style={{tableLayout: 'fixed', width: '100%', overflowX:'hidden'}}>
                            <thead>
                                <tr>
                                    <th style={{width:70}}>{t('db_hash_id')}</th>
                                    <th style={{width:40}}>{t('db_type')}</th>
                                    <th>{t('db_sequence')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {resp.rows.map((r, i) => (
                                    <tr key={i}>
                                        <td style={{fontSize:'0.65rem', opacity:0.6}}>{r.record_id.slice(0,8)}</td>
                                        <td style={{fontWeight:900, fontSize:'0.7rem', color:'var(--accent-color)'}}>{r.record_type}</td>
                                        <td className="col-dna" style={{wordBreak:'break-all', whiteSpace:'normal', lineHeight:1.4, fontSize:'8px'}}>{r.dna_sequence}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        <div style={{padding:'15px 20px', borderTop:'1px solid var(--border-color)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <div style={{fontSize:'0.6rem', color:'var(--text-secondary)', fontWeight:800}}>
                                {t('db_showing')} {( (page-1)*perPage + 1 ).toLocaleString()} - {Math.min(page*perPage, totalRows).toLocaleString()} {t('db_of')} {totalRows.toLocaleString()} {t('db_records')}
                            </div>
                            <div className="pagination-controls">
                                <button className="page-btn" onClick={() => setPage(p => Math.max(1, p - 1))} disabled={page === 1}>{t('db_prev')}</button>
                                {renderPageButtons()}
                                <button className="page-btn" onClick={() => setPage(p => Math.min(totalPages, p + 1))} disabled={page === totalPages}>{t('db_next')}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Mock API for enhancement (since no backend)
        const enhanceReadability = async (content, model, onProgress) => {
             return new Promise(resolve => {
                 let p = 0;
                 const interval = setInterval(() => {
                     p += 10;
                     if(onProgress) onProgress(p);
                     if(p >= 100) {
                         clearInterval(interval);
                         resolve(content + "\n\n[Enhanced by " + model + "]");
                     }
                 }, 100);
             });
        };

        const useDocuments = () => {
            const [documents, setDocuments] = useState([]);
            const [currentDocument, setCurrentDocument] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // Initial load: sync docs folder and fetch all documents
            useEffect(() => {
                const init = async () => {
                    setIsLoading(true);
                    try {
                        // Sync docs folder first
                        await fetch('/api/docs/sync-folder', { method: 'POST' });
                        // Then load all documents
                        const res = await fetch('/api/docs/list');
                        const data = await res.json();
                        if (data.documents) {
                            // Convert to frontend format
                            setDocuments(data.documents.map(d => ({
                                id: d.id,  // 백엔드에서 이미 doc_id를 id로 변환함
                                title: d.title,
                                content: '', // Content loaded on select
                                source_type: d.source_type,
                                createdAt: d.created_at
                            })));
                        }
                    } catch(e) {
                        console.error('Failed to load documents:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                init();
            }, []);

            const createDocument = async (title) => {
                try {
                    const res = await fetch('/api/docs', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ title, content: '' })
                    });
                    const data = await res.json();
                    if (data.doc_id) {
                        const newDoc = { id: data.doc_id, title, content: '', source_type: 'user', createdAt: new Date().toISOString() };
                        setDocuments(prev => [newDoc, ...prev]);
                        setCurrentDocument(newDoc);
                        return newDoc;
                    }
                } catch(e) {
                    console.error('Failed to create document:', e);
                }
                return null;
            };

            const updateDocument = async (id, updates) => {
                try {
                    await fetch(`/api/docs/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updates)
                    });
                    setDocuments(prev => prev.map(d => d.id === id ? { ...d, ...updates } : d));
                    if (currentDocument?.id === id) setCurrentDocument(prev => ({ ...prev, ...updates }));
                } catch(e) {
                    console.error('Failed to update document:', e);
                }
            };

            const deleteDocument = async (id) => {
                try {
                    await fetch(`/api/docs/${id}`, { method: 'DELETE' });
                    setDocuments(prev => prev.filter(d => d.id !== id));
                    if (currentDocument?.id === id) setCurrentDocument(null);
                } catch(e) {
                    console.error('Failed to delete document:', e);
                }
            };

            const selectDocument = async (id) => {
                const doc = documents.find(d => d.id === id);
                if (doc) {
                    // Load full content from server
                    try {
                        const res = await fetch(`/api/docs/${id}`);
                        const data = await res.json();
                        if (data.document) {
                            const fullDoc = { 
                                ...doc, 
                                content: data.document.content || '',
                                enhanced_content: data.document.enhanced_content || ''
                            };
                            setCurrentDocument(fullDoc);
                            // Update in list too
                            setDocuments(prev => prev.map(d => d.id === id ? fullDoc : d));
                        }
                    } catch(e) {
                        console.error('Failed to load document content:', e);
                        setCurrentDocument(doc);
                    }
                } else {
                    setCurrentDocument(null);
                }
            };

            const exportDocument = (doc) => {
                const contentToExport = doc.enhanced_content || doc.content;
                const blob = new Blob([contentToExport], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${doc.title || 'untitled'}.md`;
                a.click();
            };

            const importDocument = async (file) => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = async e => {
                        const content = e.target.result;
                        const title = file.name.replace('.md','').replace('.txt','');
                        const newDoc = await createDocument(title);
                        if (newDoc) {
                            await updateDocument(newDoc.id, { content });
                        }
                        resolve(newDoc);
                    };
                    reader.readAsText(file);
                });
            };

            const saveDocumentToFile = async (title, content) => {
                await fetch('/api/docs/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title, content })
                });
            };

            return { documents, currentDocument, isLoading, createDocument, updateDocument, deleteDocument, selectDocument, enhanceReadability, exportDocument, importDocument, saveDocumentToFile };
        };

        const DocumentEditor = ({ content, onChange, placeholder }) => {
             return (
                 <textarea 
                    className="doc-editor" 
                    value={content} 
                    onChange={e => onChange(e.target.value)} 
                    placeholder={placeholder} 
                    spellCheck="false"
                 />
             );
        };

        const DocumentPreview = ({ content }) => {
             const html = marked.parse(content || '');
             return <div className="doc-preview markdown-body" dangerouslySetInnerHTML={{ __html: html }} />;
        };

        const DocumentDiff = ({ original, enhanced }) => {
             return (
                 <div style={{display:'flex', height:'100%'}}>
                     <div style={{flex:1, borderRight:'1px solid var(--border-color)', padding:20, overflow:'auto'}}>
                        <h4>ORIGINAL</h4>
                        <div className="markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(original || '') }} />
                     </div>
                     <div style={{flex:1, padding:20, overflow:'auto'}}>
                        <h4>ENHANCED</h4>
                        <div className="markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(enhanced || '') }} />
                     </div>
                 </div>
             );
        };

        const DocumentsPanel = () => {
             const { t, lang } = useContext(AppContext);
             const isKorean = lang === 'ko';
             const { documents, currentDocument, isLoading, createDocument, updateDocument, deleteDocument, selectDocument, enhanceReadability, exportDocument, importDocument } = useDocuments();
             
             const [mode, setMode] = useState('edit');
             const [editTitle, setEditTitle] = useState('');
             const [editContent, setEditContent] = useState('');
             const fileInputRef = useRef(null);
             
             const [isEnhancing, setIsEnhancing] = useState(false);
             const [enhanceProgress, setEnhanceProgress] = useState(0); 
             const [showDiff, setShowDiff] = useState(false);
             const [enhancedContent, setEnhancedContent] = useState('');
             const [diffOriginal, setDiffOriginal] = useState(''); // Snapshot for Diff View
             const [selectedModel, setSelectedModel] = useState('gemini-2.5-flash');
             const [showModelSelect, setShowModelSelect] = useState(false);
             const [viewVersion, setViewVersion] = useState('original'); // 'original' or 'enhanced' 

             const models = [
                { id: 'gpt-4o', name: 'GPT-4o', provider: 'OpenAI' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini', provider: 'OpenAI' },
                { id: 'gemini-3-pro-preview', name: 'Gemini 3.0 Pro Preview', provider: 'Google' },
                { id: 'gemini-3-flash-preview', name: 'Gemini 3.0 Flash Preview', provider: 'Google' },
                { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', provider: 'Google' },
                { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', provider: 'Google' },
                { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', provider: 'Google' },
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', provider: 'Google' },
                { id: 'claude-3-5-sonnet-20240620', name: 'Claude 3.5 Sonnet', provider: 'Anthropic' },
             ];

             useEffect(() => {
                 if (currentDocument) {
                     setEditTitle(currentDocument.title);
                     setEditContent(currentDocument.content);
                     setViewVersion('original'); // 기본은 항상 원본
                 } else {
                     setEditTitle('');
                     setEditContent('');
                     setViewVersion('original');
                 }
             }, [currentDocument]);

             const handleSelectDocument = (id) => {
                 if (currentDocument && (editTitle !== currentDocument.title || editContent !== currentDocument.content)) {
                     updateDocument(currentDocument.id, { title: editTitle, content: editContent });
                 }
                 selectDocument(id);
                 setMode('preview'); // 기본 보기 모드로 시작
             };
             
             const handleCreateDocument = () => {
                 createDocument(isKorean ? '새 문서' : 'New Document');
             };

             const handleSave = () => {
                 if (currentDocument) updateDocument(currentDocument.id, { title: editTitle, content: editContent });
             };
             
             const handleDelete = () => {
                 if (confirm(isKorean ? '삭제하시겠습니까?' : 'Delete?')) deleteDocument(currentDocument.id);
             };
             
             const handleImport = async (e) => {
                 if(e.target.files?.[0]) importDocument(e.target.files[0]);
             };
             
             const handleEnhanceClick = () => setShowModelSelect(true);
             const handleEnhanceConfirm = async () => {
                 setShowModelSelect(false);
                 setIsEnhancing(true);
                 setEnhanceProgress(10);
                 setDiffOriginal(editContent); // Capture snapshot of original content
                 
                 const interval = setInterval(() => {
                     setEnhanceProgress(prev => (prev < 90 ? prev + 5 : prev));
                 }, 400);

                 try {
                     const response = await fetch('/api/docs/enhance', {
                         method: 'POST',
                         headers: {'Content-Type': 'application/json'},
                         body: JSON.stringify({ content: editContent, model: selectedModel })
                     });
                     
                     const data = await response.json();
                     
                     if (response.ok && data.status === 'success') {
                          setEnhancedContent(data.enhanced_content);
                          setShowDiff(true);
                     } else {
                          alert(data.message || 'Error enhancing document');
                     }
                 } catch (e) {
                     alert('API Error: ' + e.message);
                 } finally {
                     clearInterval(interval);
                     setEnhanceProgress(100);
                     setTimeout(() => setIsEnhancing(false), 500);
                 }
             };
             
             const handleApplyEnhancement = async () => {
                 try {
                     await updateDocument(currentDocument.id, { enhanced_content: enhancedContent });
                     setViewVersion('enhanced');
                     setMode('preview');
                     setShowDiff(false);
                     // Update currentDocument locally
                     currentDocument.enhanced_content = enhancedContent;
                 } catch (e) {
                     alert('Failed to save enhancement');
                 }
             };
             
             useEffect(() => { lucide.createIcons(); }, [documents, mode, showDiff, showModelSelect, isEnhancing]);

             return (
                 <div className="doc-panel">
                     <div className="doc-sidebar">
                         <div style={{padding:'12px 15px', borderBottom:'1px solid var(--border-color)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                             <span style={{fontSize:'0.7rem', fontWeight:800, color:'var(--accent-color)'}}>DOCUMENTS</span>
                             <div style={{display:'flex', gap:5}}>
                                <button className="doc-btn" onClick={handleCreateDocument} title="New Document"><LucideIcon name="plus" size={14} /></button>
                                <button className="doc-btn" onClick={()=>fileInputRef.current?.click()} title="Import"><LucideIcon name="upload" size={14} /></button>
                             </div>
                             <input type="file" ref={fileInputRef} style={{display:'none'}} onChange={handleImport} accept=".md,.txt" />
                         </div>
                         <div className="doc-list">
                             {isLoading && <div style={{padding:20, textAlign:'center', opacity:0.5, fontSize:'0.7rem'}}>Loading...</div>}
                             {!isLoading && documents.length === 0 && <div style={{padding:20, textAlign:'center', opacity:0.5, fontSize:'0.7rem'}}>No documents</div>}
                            {documents.map(doc => (
                                 <div key={doc.id} className={`doc-item ${currentDocument?.id===doc.id?'active':''}`} onClick={()=>handleSelectDocument(doc.id)}>
                                     <LucideIcon name={doc.source_type === 'system' ? 'folder' : 'file-text'} size={14} style={{opacity:0.7}} />
                                     <span style={{flex:1, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{doc.title}</span>
                                 </div>
                             ))}
                         </div>
                     </div>
                     
                     <div className="doc-main">
                         {currentDocument ? (
                             <>
                                <div className="doc-toolbar">
                                    <input className="doc-title-input" value={editTitle} onChange={e=>setEditTitle(e.target.value)} placeholder="Untitled" />
                                    <div style={{display:'flex', gap:8, alignItems:'center'}}>
                                        {currentDocument.enhanced_content && !showDiff && (
                                            <div className="mode-switcher" style={{marginRight:10}}>
                                                <button className={`mode-btn ${viewVersion==='original'?'active':''}`} style={{fontSize:'0.6rem', padding:'4px 8px'}} onClick={()=>setViewVersion('original')}>ORIGINAL</button>
                                                <button className={`mode-btn ${viewVersion==='enhanced'?'active':''}`} style={{fontSize:'0.6rem', padding:'4px 8px'}} onClick={()=>{setViewVersion('enhanced'); setMode('preview');}}>ENHANCED</button>
                                            </div>
                                        )}
                                        <button className={`doc-btn ${mode==='edit'?'active':''}`} onClick={()=>{setMode('edit'); setViewVersion('original');}}><LucideIcon name="edit-3" size={12} /> {t('doc_edit')}</button>
                                        <button className={`doc-btn ${mode==='preview'?'active':''}`} onClick={()=>setMode('preview')}><LucideIcon name="eye" size={12} /> {t('doc_preview')}</button>
                                        <div style={{width:1, height:16, background:'var(--border-color)', margin:'0 5px'}}></div>
                                        <button className="doc-btn" onClick={handleEnhanceClick} style={{color:'var(--accent-color)', borderColor:'var(--accent-color)'}}><LucideIcon name="sparkles" size={12} /> {t('doc_enhance')}</button>
                                        <button className="doc-btn" onClick={handleSave}><LucideIcon name="save" size={12} /></button>
                                        <button className="doc-btn" onClick={()=>exportDocument(currentDocument)}><LucideIcon name="download" size={12} /></button>
                                        <button className="doc-btn" onClick={handleDelete} style={{color:'var(--danger-color)', borderColor:'var(--danger-color)'}}><LucideIcon name="trash-2" size={12} /></button>
                                    </div>
                                </div>
                                <div className="doc-body" key={currentDocument.id + mode + (showDiff ? '_diff' : '') + viewVersion}>
                                    {mode==='edit' && !showDiff && <DocumentEditor content={editContent} onChange={setEditContent} placeholder="Markdown..." />}
                                    {mode==='preview' && !showDiff && <DocumentPreview content={viewVersion === 'enhanced' ? currentDocument.enhanced_content : editContent} />}
                                    {showDiff && <DocumentDiff original={diffOriginal} enhanced={enhancedContent} />}
                                </div>
                             </>
                         ) : (
                             <div className="doc-empty">
                                 <LucideIcon name="file-text" size={48} style={{opacity:0.2}} />
                                 <span>Select or Create Document</span>
                             </div>
                         )}
                     </div>

                     {showModelSelect && (
                         <div style={{position:'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.8)', zIndex:9999, display:'flex', alignItems:'center', justifyContent:'center'}}>
                             <div className="card" style={{width:400, maxWidth:'90%'}}>
                                 <div className="card-header"><span className="card-title">{t('doc_model_title')}</span></div>
                                 <div className="card-body">
                                     <div style={{display:'flex', flexDirection:'column', gap:8}}>
                                         {models.map(m => (
                                             <button key={m.id} className={`mode-btn ${selectedModel===m.id?'active':''}`} style={{textAlign:'left', border:'1px solid var(--border-color)'}} onClick={()=>setSelectedModel(m.id)}>
                                                 <div style={{fontWeight:700}}>{m.name}</div>
                                                 <div style={{fontSize:'0.6rem', opacity:0.7}}>{m.provider}</div>
                                             </button>
                                         ))}
                                     </div>
                                     <div style={{display:'flex', justifyContent:'flex-end', gap:10, marginTop:20}}>
                                         <button className="btn" onClick={()=>setShowModelSelect(false)}>{t('doc_model_cancel')}</button>
                                         <button className="btn btn-accent" onClick={handleEnhanceConfirm}>{t('doc_model_confirm')}</button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     )}
                     
                     {isEnhancing && (
                         <div style={{position:'absolute', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.5)', zIndex:9998, display:'flex', alignItems:'center', justifyContent:'center', backdropFilter:'blur(2px)'}}>
                             <div className="card" style={{padding:20, display:'flex', flexDirection:'column', alignItems:'center', gap:15, width:300}}>
                                 <div style={{display:'flex', alignItems:'center', gap:10}}>
                                      <i data-lucide="loader-2" className="pulse" style={{width:24, height:24, color:'var(--accent-color)'}}></i>
                                      <span style={{fontWeight:800}}>{t('doc_enhancing')} {enhanceProgress}%</span>
                                 </div>
                                 <div style={{width:'100%', height:4, background:'var(--bg-accent)', border:'1px solid var(--border-color)'}}>
                                     <div style={{width:`${enhanceProgress}%`, height:'100%', background:'var(--accent-color)', transition:'width 0.1s'}}></div>
                                 </div>
                             </div>
                         </div>
                     )}
                     
                     {showDiff && (
                       <div style={{position:'absolute', bottom: 20, right: 20, zIndex: 100, display:'flex', gap:10}}>
                           <button className="btn" onClick={()=>setShowDiff(false)}>CANCEL</button>
                           <button className="btn btn-accent" onClick={handleApplyEnhancement}>APPLY & SAVE</button>
                       </div>
                     )}
                 </div>
             );
        };

        const RecordFeed = () => {
            const { downloadedCount } = useContext(AppContext);
            const [resp, setResp] = useState({rows:[], pagination:{total_pages:1}});
            const [page, setPage] = useState(1);
            const [loading, setLoading] = useState(false);

            useEffect(() => { 
                setLoading(true);
                fetch(`/api/database/tables/genetic_records?page=${page}&per_page=20`)
                    .then(r=>r.json())
                    .then(d => { setResp(d); setLoading(false); }); 
            }, [page, downloadedCount]);

            return (
                <div className="card">
                    <div className="card-header" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                        <span className="card-title">Analysis Timeline</span>
                        <div className="pagination-controls">
                            <button className="page-btn" onClick={() => setPage(p => Math.max(1, p - 1))} disabled={page === 1}>PREV</button>
                            <span style={{fontSize:'0.6rem', padding:'0 10px', fontWeight:800}}>PAGE {page} / {resp.pagination?.total_pages || 1}</span>
                            <button className="page-btn" onClick={() => setPage(p => Math.min(resp.pagination?.total_pages || 1, p + 1))} disabled={page === resp.pagination?.total_pages}>NEXT</button>
                        </div>
                    </div>
                    <div className="card-body" style={{padding:0, position:'relative'}}>
                        {loading && <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.3)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:10, fontSize:'0.7rem', fontWeight:900, color:'var(--accent-color)'}}>LOADING_ARCHIVE...</div>}
                        <div className="log-box" style={{height:'600px', border:'none', overflowY:'auto'}}>
                            {resp.rows.map(r=>(<div key={r.record_id} style={{padding:'18px 25px', borderBottom:'1px solid var(--border-color)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span style={{fontSize:'0.8rem', fontWeight:600}}><span style={{color:'var(--accent-color)', fontWeight:900}}>[{r.record_type}]</span> {r.record_id.slice(0,40)}...</span>
                                <span style={{background:'var(--accent-color)', color: (localStorage.getItem('theme')==='mono' && localStorage.getItem('sysMode')==='light') ? '#fff' : 'var(--btn-text)', padding:'4px 10px', fontWeight:900, fontSize:'0.7rem'}}>{r.predicted_type}</span>
                            </div>))}
                        </div>
                    </div>
                </div>
            );
        }

        const FullDatabasePanel = () => {
            const [tables, setTables] = useState([]);
            const [selectedTable, setSelectedTable] = useState('genetic_records');
            const [resp, setResp] = useState(null);
            const [page, setPage] = useState(1);
            const [perPage, setPerPage] = useState(50);
            const [loading, setLoading] = useState(false);

            // Fetch table list on mount
            useEffect(() => {
                fetch('/api/database/tables')
                    .then(r => r.json())
                    .then(d => {
                        if (d.tables) setTables(d.tables);
                    });
            }, []);

            // Fetch data when table or page changes
            useEffect(() => {
                setLoading(true);
                fetch(`/api/database/tables/${selectedTable}?page=${page}&per_page=${perPage}`)
                    .then(r => r.json())
                    .then(d => { setResp(d); setLoading(false); });
            }, [selectedTable, page, perPage]);

            // Reset page when table changes
            useEffect(() => {
                setPage(1);
            }, [selectedTable]);

            if (!resp) return null;

            const fullColumns = resp.columns || [];
            const totalRows = resp.pagination?.total_rows || 0;
            const totalPages = resp.pagination?.total_pages || 1;

            // Determine column width based on column name
            // seq (dna_sequence) gets the largest width, others are compact
            const getColumnStyle = (colName) => {
                const isSeq = colName === 'dna_sequence' || colName === 'sequence' || colName.includes('seq');
                if (isSeq) {
                    return { minWidth: '300px', flex: '1 1 auto' };
                }
                // Compact width for other columns
                if (colName === 'record_id' || colName === 'id') return { width: '100px', flex: '0 0 100px' };
                if (colName === 'record_type' || colName === 'type') return { width: '60px', flex: '0 0 60px' };
                if (colName.includes('time') || colName.includes('date')) return { width: '140px', flex: '0 0 140px' };
                if (colName === 'predicted_type') return { width: '80px', flex: '0 0 80px' };
                return { width: '100px', flex: '0 0 100px' };
            };

            const renderPageButtons = () => {
                const buttons = [];
                let startPage = Math.max(1, page - 3);
                let endPage = Math.min(totalPages, page + 3);

                if (startPage > 1) {
                    buttons.push(<button key={1} className="page-btn" onClick={()=>setPage(1)}>1</button>);
                    if (startPage > 2) buttons.push(<span key="e1">...</span>);
                }

                for (let i = startPage; i <= endPage; i++) {
                    buttons.push(<button key={i} className={`page-btn ${page===i?'active':''}`} onClick={()=>setPage(i)}>{i}</button>);
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) buttons.push(<span key="e2">...</span>);
                    buttons.push(<button key={totalPages} className="page-btn" onClick={()=>setPage(totalPages)}>{totalPages}</button>);
                }
                return buttons;
            };

            return (
                <div style={{display:'flex', height:'calc(100vh - 180px)', gap:0, margin:'-30px -30px -30px 0', width:'calc(100% + 30px)'}}>
                    {/* Left Sidebar - Table Selector - Fixed */}
                    <div style={{width:'160px', minWidth:'160px', flexShrink:0, background:'var(--bg-accent)', borderRight:'1px solid var(--border-color)', display:'flex', flexDirection:'column'}}>
                        <div style={{padding:'12px 15px', borderBottom:'1px solid var(--border-color)', fontSize:'0.6rem', fontWeight:900, color:'var(--accent-color)', letterSpacing:1}}>
                            DATABASE TABLES
                        </div>
                        <div style={{flex:1, overflowY:'auto'}}>
                            {tables.map(tbl => (
                                <div 
                                    key={tbl} 
                                    onClick={() => setSelectedTable(tbl)}
                                    style={{
                                        padding:'12px 20px',
                                        fontSize:'0.7rem',
                                        fontWeight: selectedTable === tbl ? 900 : 600,
                                        color: selectedTable === tbl ? 'var(--accent-color)' : 'var(--text-secondary)',
                                        background: selectedTable === tbl ? 'rgba(124, 77, 255, 0.1)' : 'transparent',
                                        borderLeft: selectedTable === tbl ? '3px solid var(--accent-color)' : '3px solid transparent',
                                        cursor:'pointer',
                                        transition:'all 0.15s'
                                    }}
                                >
                                    {tbl}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Right Content - Data View */}
                    <div className="card" style={{flex:1, display:'flex', flexDirection:'column', margin:0, border:'none'}}>
                        <div className="card-header" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <span className="card-title">{selectedTable.toUpperCase()} ({totalRows.toLocaleString()})</span>
                            <div style={{display:'flex', gap:10, alignItems:'center'}}>
                                <span style={{fontSize:'0.6rem', fontWeight:800, color:'var(--text-secondary)'}}>ROWS</span>
                                <select className="type-toggle-btn" style={{padding:'2px 8px', height:24, fontSize:'0.6rem'}} value={perPage} onChange={(e)=>{setPerPage(Number(e.target.value)); setPage(1);}}>
                                    <option value={20}>20</option>
                                    <option value={50}>50</option>
                                    <option value={100}>100</option>
                                    <option value={500}>500</option>
                                </select>
                            </div>
                        </div>
                        <div className="card-body" style={{padding:0, flex:1, overflow:'hidden', position:'relative', display:'flex', flexDirection:'column'}}>
                            {loading && <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.3)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:10, fontSize:'0.8rem', fontWeight:900, color:'var(--accent-color)'}}>FETCHING DATA...</div>}
                            
                            <div style={{flex:1, overflow:'auto'}}>
                                <table className="db-table" style={{width:'100%', tableLayout:'fixed'}}>
                                    <thead style={{position:'sticky', top:0, zIndex:1}}>
                                        <tr>
                                            {fullColumns.map(col => {
                                                const isSeq = col.name === 'dna_sequence' || col.name === 'sequence' || col.name.includes('seq');
                                                const colStyle = getColumnStyle(col.name);
                                                return (
                                                    <th key={col.name} style={{
                                                        fontSize:'0.6rem', 
                                                        whiteSpace:'nowrap',
                                                        overflow:'hidden',
                                                        textOverflow:'ellipsis',
                                                        width: colStyle.width || 'auto',
                                                        minWidth: colStyle.minWidth || colStyle.width || '60px',
                                                        padding:'10px 8px'
                                                    }}>
                                                        {col.name} <span style={{opacity:0.5, fontSize:'0.45rem'}}>({col.type})</span>
                                                    </th>
                                                );
                                            })}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {resp.rows.map((row, i) => (
                                            <tr key={i}>
                                                {fullColumns.map(col => {
                                                    const isSeq = col.name === 'dna_sequence' || col.name === 'sequence' || col.name.includes('seq');
                                                    const isMeta = col.name === 'source_metadata' || col.name.includes('metadata');
                                                    const isContent = col.name === 'content';
                                                    const colStyle = getColumnStyle(col.name);
                                                    
                                                    // 긴 컬럼 자르기
                                                    let cellValue = row[col.name];
                                                    if ((isMeta || isContent) && cellValue && typeof cellValue === 'string' && cellValue.length > 50) {
                                                        cellValue = cellValue.substring(0, 50) + '...';
                                                    }
                                                    
                                                    return (
                                                        <td key={col.name} style={{
                                                            fontSize: isSeq ? '0.55rem' : '0.6rem', 
                                                            whiteSpace: (isMeta || isContent) ? 'normal' : 'normal',
                                                            wordBreak: 'break-all',
                                                            overflowWrap: 'break-word',
                                                            width: colStyle.width || 'auto',
                                                            minWidth: colStyle.minWidth || colStyle.width || '60px',
                                                            fontFamily: isSeq ? 'Fira Code, monospace' : 'inherit',
                                                            color: isSeq ? 'var(--neon-green)' : 'var(--text-secondary)',
                                                            lineHeight: '1.4',
                                                            padding:'8px',
                                                            maxWidth: (isMeta || isContent) ? '200px' : 'none'
                                                        }}>
                                                            {cellValue ?? '-'}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div style={{padding:'15px 20px', borderTop:'1px solid var(--border-color)', display:'flex', justifyContent:'space-between', alignItems:'center', background:'var(--bg-secondary)'}}>
                                 <div style={{fontSize:'0.6rem', color:'var(--text-secondary)', fontWeight:800}}>
                                    Showing {( (page-1)*perPage + 1 ).toLocaleString()} - {Math.min(page*perPage, totalRows).toLocaleString()} of {totalRows.toLocaleString()}
                                </div>
                                <div className="pagination-controls">
                                    <button className="page-btn" onClick={() => setPage(p => Math.max(1, p - 1))} disabled={page === 1}>PREV</button>
                                    {renderPageButtons()}
                                    <button className="page-btn" onClick={() => setPage(p => Math.min(totalPages, p + 1))} disabled={page === totalPages}>NEXT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportPanel = () => {
            const { lang } = useContext(AppContext);
            const [content, setContent] = useState('');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                setLoading(true);
                fetch(`/api/docs/report?lang=${lang}`)
                    .then(r => r.json())
                    .then(d => {
                        setContent(d.content || 'Report not found.');
                        setLoading(false);
                    })
                    .catch(err => {
                        setContent('Error loading report.');
                        setLoading(false);
                    });
            }, [lang]);

            const renderMarkdown = (text) => {
                if (!window.marked) return { __html: text };
                // marked options
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
                return { __html: marked.parse(text) };
            };

            return (
                <div className="card" style={{height:'calc(100vh - 120px)', display:'flex', flexDirection:'column'}}>
                    <div className="card-header">
                        <span className="card-title">PROJECT README [{lang.toUpperCase()}]</span>
                    </div>
                    <div className="card-body" style={{flex:1, overflowY:'auto', background:'var(--bg-secondary)', position:'relative', padding: '40px 60px'}}>
                        {loading && <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.3)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:10, fontSize:'0.8rem', fontWeight:900, color:'var(--accent-color)'}}>DECRYPTING_REPORT...</div>}
                        <div className="markdown-body" dangerouslySetInnerHTML={renderMarkdown(content)} />
                    </div>
                </div>
            );
        };


        const HuggingFacePanel = () => {
            const { t } = useContext(AppContext);
            
            // Simple encryption/decryption helpers
            const encrypt = (text) => { try { return btoa(text); } catch (e) { return text; } };
            const decrypt = (text) => { try { return atob(text); } catch (e) { return text; } };

            const [token, setToken] = useState(() => {
                const saved = localStorage.getItem('hf_token');
                return saved ? decrypt(saved) : '';
            });
            const [repoId, setRepoId] = useState(() => localStorage.getItem('hf_repo_id') || '');
            
            const [uploading, setUploading] = useState(false);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                if (token) localStorage.setItem('hf_token', encrypt(token));
            }, [token]);

            useEffect(() => {
                if (repoId) localStorage.setItem('hf_repo_id', repoId);
            }, [repoId]);


            const handleUpload = async () => {
                if (!token || !repoId) {
                    alert('Please enter both Token and Repo ID.');
                    return;
                }
                
                setUploading(true);
                setMessage(null);
                
                try {
                    const r = await fetch('/api/ml/upload-huggingface', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ token, repo_id: repoId })
                    });
                    const d = await r.json();
                    
                    if (d.status === 'success') {
                        setMessage({ type: 'success', text: d.message });
                        alert('Upload Success: ' + d.message);
                    } else {
                        setMessage({ type: 'error', text: d.message });
                        alert('Upload Failed: ' + d.message);
                    }
                } catch (e) {
                    setMessage({ type: 'error', text: 'Network Error: ' + e.message });
                    alert('Error: ' + e.message);
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div style={{maxWidth: '800px', margin: '0 auto'}}>
                    <div className="card">
                        <div className="card-header">
                            <span className="card-title">HUGGING FACE HUB UPLOAD</span>
                        </div>
                        <div className="card-body">
                            <div style={{marginBottom: 20}}>
                                <p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: 20}}>
                                    Upload your trained models (RandomForest & GradientBoosting) directly to the Hugging Face Hub.
                                </p>
                                
                                <div style={{marginBottom: 15}}>
                                    <label style={{display: 'block', fontSize: '0.75rem', fontWeight: 800, color: 'var(--text-secondary)', marginBottom: 5}}>
                                        HUGGING FACE TOKEN (WRITE PERMISSION REQUIRED)
                                    </label>
                                    <input 
                                        type="password" 
                                        value={token} 
                                        onChange={(e) => setToken(e.target.value)}
                                        placeholder="hf_..."
                                        style={{width: '100%', padding: '10px', background: 'var(--bg-primary)', border: '1px solid var(--border-color)', color: 'var(--text-primary)', fontFamily: 'Fira Code'}}
                                    />
                                </div>
                                
                                <div style={{marginBottom: 25}}>
                                    <label style={{display: 'block', fontSize: '0.75rem', fontWeight: 800, color: 'var(--text-secondary)', marginBottom: 5}}>
                                        REPOSITORY ID (USERNAME/MODEL-NAME)
                                    </label>
                                    <input 
                                        type="text" 
                                        value={repoId} 
                                        onChange={(e) => setRepoId(e.target.value)}
                                        placeholder="username/my-dna-model"
                                        style={{width: '100%', padding: '10px', background: 'var(--bg-primary)', border: '1px solid var(--border-color)', color: 'var(--text-primary)', fontFamily: 'Fira Code'}}
                                    />
                                </div>
                                
                                <button className="btn btn-accent" onClick={handleUpload} disabled={uploading}>
                                    <i data-lucide={uploading ? "loader-2" : "upload-cloud"} className={uploading ? "spin" : ""} style={{width: 16, height: 16}}></i>
                                    {uploading ? "UPLOADING..." : "UPLOAD MODELS TO HUGGING FACE"}
                                </button>
                                
                                {message && (
                                    <div style={{marginTop: 20, padding: 15, background: message.type === 'success' ? 'rgba(0, 255, 65, 0.1)' : 'rgba(255, 68, 68, 0.1)', border: `1px solid ${message.type === 'success' ? 'var(--neon-green)' : 'var(--danger-color)'}`}}>
                                        <div style={{color: message.type === 'success' ? 'var(--neon-green)' : 'var(--danger-color)', fontSize: '0.85rem', fontWeight: 700}}>
                                            {message.type === 'success' ? 'SUCCESS' : 'ERROR'}: {message.text}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="log-box" style={{height: 150, overflowY: 'auto'}}>
                                <div className="log-line">Files to be uploaded:</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- dna_classifier.joblib (RandomForest)</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- sequence_model.joblib (GradientBoosting)</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- feature_names.joblib</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- training_metrics.joblib</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- sequence_metrics.joblib</div>
                                <div className="log-line" style={{paddingLeft: 10}}>- sequence_extractor.joblib</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MainLayout = () => {
            const { t, sidebarExpanded, setSidebarExpanded, isAuto, progress, totalDataCount, downloadedCount, activeType, setActiveType, fetchSamples, toggleAuto, startTime, logs, theme, setTheme, sysMode, setSysMode, lang, setLang } = useContext(AppContext);
            const [tab, setTab] = useState('system');

            useEffect(() => {
                let interval;
                if (isAuto && startTime) {
                    interval = setInterval(() => {
                        const now = Date.now();
                        const elapsed = now - startTime;
                        
                        const eSeconds = Math.floor((elapsed / 1000) % 60);
                        const eMinutes = Math.floor((elapsed / (1000 * 60)) % 60);
                        const eHours = Math.floor((elapsed / (1000 * 60 * 60)));
                        const elapsedStr = `${String(eHours).padStart(2,'0')}:${String(eMinutes).padStart(2,'0')}:${String(eSeconds).padStart(2,'0')}`;

                        const elapsedSec = elapsed / 1000;
                        const ratePerSec = elapsedSec > 0 ? (downloadedCount / elapsedSec) : 0;
                        
                        const formatSpeed = (val) => {
                            if (val >= 1000000000) return (val / 1000000000).toFixed(1) + 'G';
                            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
                            if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
                            return val.toFixed(1);
                        };
                        
                        const remainingItems = totalDataCount - downloadedCount;
                        let remainingStr = "CALCULATING...";
                        if (ratePerSec > 0) {
                            const remainingSec = remainingItems / ratePerSec;
                            const rSeconds = Math.floor(remainingSec % 60);
                            const rMinutes = Math.floor((remainingSec / 60) % 60);
                            const rHours = Math.floor(remainingSec / 3600);
                            remainingStr = `${String(rHours).padStart(2,'0')}:${String(rMinutes).padStart(2,'0')}:${String(rSeconds).padStart(2,'0')}`;
                        }

                        const elElapsed = document.getElementById('disp-elapsed');
                        const elRemaining = document.getElementById('disp-remaining');
                        const elRate = document.getElementById('disp-rate');
                        
                        if(elElapsed) elElapsed.innerText = elapsedStr;
                        if(elRemaining) elRemaining.innerText = (remainingItems <= 0) ? "COMPLETED" : remainingStr;
                        if(elRate) elRate.innerText = `~${formatSpeed(ratePerSec)}/s`;

                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isAuto, startTime, downloadedCount, totalDataCount]);
            
            useEffect(() => { lucide.createIcons(); }, [tab, sidebarExpanded, isAuto]);

            const menu = [
                {id:'system', l:t('tab_control'), icon:'settings-2'},
                {id:'docs', l:t('tab_docs'), icon:'file-text'}, 
                {id:'master', l:t('tab_master'), icon:'server'},
                {id:'inspector', l:t('tab_neural'), icon:'activity'},
                {id:'virus', l:t('tab_virus'), icon:'bug'},
                {id:'insights', l:t('tab_insights'), icon:'sparkles'},
                {id:'simulation', l:'Simulation', icon:'play-circle'},
                {id:'huggingface', l:'HUGGING FACE', icon:'cloud-lightning'},
                {id:'report', l:t('tab_report'), icon:'file-text'},
                {id:'settings', l:t('tab_settings'), icon:'sliders'}
            ];
            
            const pct = totalDataCount > 0 ? ((downloadedCount / totalDataCount) * 100).toFixed(1) : 0;

            return (
                <div style={{display:'flex', width:'100%', height:'100%'}}>
                    <nav className={`sidebar ${sidebarExpanded ? 'expanded' : ''}`}>
                        <div className="sidebar-header">
                            <span className="sidebar-brand">{t('title')}</span>
                            <button className="toggle-btn" onClick={() => setSidebarExpanded(!sidebarExpanded)}>
                                <i data-lucide={sidebarExpanded ? "panel-left-close" : "panel-left-open"} style={{width:20, height:20}}></i>
                            </button>
                        </div>
                        <ul className="tab-list">
                            {menu.map(m=>(
                                <li key={m.id} className={`tab-item ${tab===m.id?'active':''}`} onClick={()=>setTab(m.id)}>
                                    <div className="icon-box"><i data-lucide={m.icon} style={{width:20, height:20}}></i></div>
                                    <span>{m.l}</span>
                                </li>
                            ))}
                        </ul>
                    </nav>
                    <div className="main-container">
                        <header className="content-header">
                            <h2>{menu.find(m=>m.id===tab)?.l}</h2>
                            <div className="system-status-indicator" style={{position:'relative', height:'100%'}}>
                                {/* Status Badge - Always Visible */}
                                <div className={`status-badge ${isAuto ? 'status-active' : ''}`} style={{cursor:'default'}}>
                                    <div className="status-dot"></div>
                                    <span>
                                        {isAuto ? `${activeType}_RUNNING` : `${activeType}_IDLE`}
                                    </span>
                                </div>
                                
                                {/* DB Count Display */}
                                <div style={{display:'flex', alignItems:'center', gap:6, padding:'5px 12px', background:'var(--bg-accent)', border:'1px solid var(--border-color)', fontSize:'0.6rem', fontWeight:800, color:'var(--text-secondary)'}}>
                                    <span>{downloadedCount.toLocaleString()}</span>
                                    <span style={{opacity:0.5}}>/</span>
                                    <span style={{color:'var(--accent-color)'}}>{totalDataCount.toLocaleString()}</span>
                                </div>
                                
                                {/* Progress Bars - Always Visible */}
                                <div style={{display:'flex', alignItems:'center', gap:8}}>
                                    <div style={{display:'flex', flexDirection:'column', gap:4}}>
                                        {/* Batch Progress (200 items) */}
                                        <div style={{display:'flex', alignItems:'center', gap:6}}>
                                            <span style={{fontSize:'0.5rem', fontWeight:800, color:'var(--text-secondary)', minWidth:40}}>BATCH</span>
                                            <div className="status-progress-container" style={{width:80}}>
                                                <div className="status-progress-bar" style={{width: isAuto ? `${progress}%` : '0%'}}></div>
                                            </div>
                                        </div>
                                        {/* Overall Progress */}
                                        <div style={{display:'flex', alignItems:'center', gap:6}}>
                                            <span style={{fontSize:'0.5rem', fontWeight:800, color:'var(--text-secondary)', minWidth:40}}>TOTAL</span>
                                            <div className="status-progress-container" style={{width:80}}>
                                                <div className="status-progress-bar" style={{width: `${pct}%`, background:'var(--neon-green)'}}></div>
                                            </div>
                                        </div>
                                    </div>
                                    <span style={{fontSize:'0.65rem', fontWeight:800, color: isAuto ? 'var(--accent-color)' : 'var(--text-secondary)'}}>{pct}%</span>
                                </div>
                                
                                {/* HOVER PANEL - Always Available */}
                                <div className="status-hover-panel">
                                    <div style={{fontSize:'0.7rem', fontWeight:900, marginBottom:10, color:'var(--accent-color)', letterSpacing:1}}>
                                        {isAuto ? t('st_active') : t('st_system')}
                                    </div>
                                    <div className="panel-row" style={{background:'var(--bg-accent)', margin:'-2px -5px 10px', padding:'8px 10px'}}>
                                        <span>{t('st_bot_mode')}</span>
                                        <span className="panel-val" style={{color:'var(--accent-color)', fontWeight:900}}>
                                            {activeType} {isAuto ? `🟢 ${t('st_running')}` : `⚪ ${t('st_idle')}`}
                                        </span>
                                    </div>
                                    <div className="panel-row">
                                        <span>{t('st_status')}</span>
                                        <span className="panel-val" style={{color: isAuto ? 'var(--neon-green)' : 'var(--text-secondary)'}}>
                                            {isAuto ? t('st_auto') : t('st_standby')}
                                        </span>
                                    </div>
                                    <div className="panel-row"><span>{t('st_total')}</span><span className="panel-val">{totalDataCount.toLocaleString()}</span></div>
                                    <div className="panel-row"><span>{t('st_down')}</span><span className="panel-val">{downloadedCount.toLocaleString()}</span></div>
                                    <div className="panel-row"><span>{t('st_remain')}</span><span className="panel-val">{(totalDataCount - downloadedCount).toLocaleString()}</span></div>
                                    {isAuto && (
                                        <>
                                            <div style={{marginTop:12, marginBottom:6, fontSize:'0.6rem', color:'var(--text-secondary)', fontWeight:800}}>{t('st_batch')}</div>
                                            <div style={{height:4, background:'var(--bg-accent)', marginBottom:8, position:'relative'}}><div style={{height:'100%', background:'var(--accent-color)', width:`${progress}%`, transition:'width 0.1s'}}></div></div>
                                            <div style={{fontSize:'0.6rem', color:'var(--text-secondary)', fontWeight:800}}>{t('st_overall')}</div>
                                            <div style={{height:4, background:'var(--bg-accent)', margin:'6px 0 12px', position:'relative'}}><div style={{height:'100%', background:'var(--neon-green)', width:`${pct}%`}}></div></div>
                                            <div className="panel-row"><span>{t('st_elapsed')}</span><span className="panel-val" id="disp-elapsed">00:00:00</span></div>
                                            <div className="panel-row"><span>{t('st_est')}</span><span className="panel-val" id="disp-remaining">CALCULATING...</span></div>
                                            <div className="panel-row"><span>{t('st_speed')}</span><span className="panel-val" id="disp-rate">--/s</span></div>
                                        </>
                                    )}
                                    {!isAuto && (
                                        <div style={{marginTop:12, padding:'10px', background:'rgba(0,0,0,0.3)', border:'1px solid var(--border-color)', fontSize:'0.6rem', color:'var(--text-secondary)', textAlign:'center'}}>
                                            {t('st_guide').split('\n').map((line, i) => <React.Fragment key={i}>{line}<br/></React.Fragment>)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </header>
                         <main className="main-content">
                            {tab==='system' && <ControlPanel />}
                            {tab==='docs' && <DocumentsPanel />}
                            {tab==='master' && <FullDatabasePanel />}
                            {tab==='report' && <ReportPanel />}
                            {tab==='settings' && <SettingsPanel />}
                            {tab==='inspector' && <NeuralPanel />}
                            {tab==='virus' && <VirusAnalysisPanel />}
                            {tab==='insights' && <InsightsPanel />}
                            {tab==='simulation' && <SimulationPanel />}
                            {tab==='huggingface' && <HuggingFacePanel />}
                        </main>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<AppProvider><MainLayout /></AppProvider>);
    </script>
</body>
</html>
